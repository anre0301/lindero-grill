<!doctype html> 
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Lindero Grill • POS</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
<style>
  :root{
    --bg:#0e0f12; --surface:#121318; --soft:#1a1c22; --line:rgba(255,255,255,.08);
    --text:#ecf0f8; --muted:#a7b0c2;
    --accent:#ff7a00; --accent2:#ffb347;
    --ok:#22c55e; --warn:#f59e0b; --info:#3b82f6; --danger:#ef4444;
    --ticket-width:58mm;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  img{max-width:100%;display:block}
  .muted{opacity:.75}

  /* ===== Topbar ===== */
  .top{position:sticky;top:0;z-index:30;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(14,15,18,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .brand{font-weight:900}.brand b{color:var(--accent)}
  .pill{border:1px solid var(--line);background:#17191f;border-radius:999px;padding:8px 12px;color:#dfe7f3;text-decoration:none}
  .pill.btn{cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .money{background:linear-gradient(135deg,#1f8a41,#93f9a4);color:#072311;border:none;font-weight:800}
  .wrap{max-width:1400px;margin:16px auto;padding:0 16px}

  /* ===== Tabs ===== */
  .subtabs{display:flex;gap:8px;margin:8px 0 14px;flex-wrap:wrap}
  .tab{padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:#17191f;cursor:pointer}
  .tab.active{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#261106;border:none;font-weight:800}

  /* ===== Layout 2 columnas ===== */
  .grid2{display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start}
  @media (max-width:1100px){
    .grid2{grid-template-columns:1fr}
    .side{order:2}
  }

  /* ===== Board Mesas ===== */
  .board{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
  @media (max-width:1200px){ .board{grid-template-columns:repeat(4,1fr)} }
  @media (max-width:900px){  .board{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:600px){  .board{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:420px){  .board{grid-template-columns:1fr} }

  .tile{position:relative;background:#151821;border:1px solid var(--line);border-radius:22px;padding:12px;min-height:128px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;transition:.15s}
  .tile:hover{transform:translateY(-2px)}
  .tile.has-order{background:#0d2230;border-color:rgba(14,165,233,.35)}
  .tile .edit{position:absolute;right:8px;top:8px;width:36px;height:36px;border-radius:10px;border:1px solid var(--line);background:#10141b;color:#dfe7f3;display:grid;place-items:center;cursor:pointer}
  .tile .edit:hover{background:#17202b}
  .num{font-weight:900}
  .preview{margin-top:6px;background:linear-gradient(180deg, rgba(14,165,233,.25), rgba(14,165,233,.18));color:#e9f8ff;border:1px solid rgba(14,165,233,.35);border-radius:14px;padding:8px}
  .pv-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .pv-chip{background:#0ea5e9;color:#082431;border:none;border-radius:999px;padding:3px 10px;font-weight:800;white-space:nowrap}
  .pv-sub{display:flex;gap:12px;align-items:center;opacity:.95;flex-wrap:wrap}
  .pv-sub small{opacity:.9}
  .tag{padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:.8rem;background:#1b1f28;opacity:.8;align-self:flex-start}

  /* ===== Lateral (carrito) ===== */
  .side{position:sticky;top:72px;background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:14px}
  .list{display:flex;flex-direction:column;gap:10px;max-height:48vh;overflow:auto}
  .item{display:grid;grid-template-columns:1fr 100px 32px;align-items:center;gap:8px;background:#151821;border:1px solid var(--line);border-radius:12px;padding:10px}
  .qty{display:flex;gap:6px;justify-content:flex-end;align-items:center}
  .qty button{min-width:36px;height:36px;border-radius:10px;border:1px solid var(--line);background:#1a1d25;color:#dfe7f3;cursor:pointer}
  .rm{width:36px;height:36px;display:grid;place-items:center}
  .tot{border-top:1px dashed var(--line);margin-top:8px;padding-top:8px}
  .row{display:flex;justify-content:space-between;margin:6px 0;gap:10px}
  .row.total{font-weight:800}
  .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .btn{border-radius:12px;padding:10px 12px;border:1px solid var(--line);cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#251109;border:none;font-weight:800}
  .btn.ok{background:linear-gradient(135deg,var(--ok),#a7efb1);color:#06260e;border:none;font-weight:800}
  .btn.warn{background:#1f2a3d;color:#d9e7ff;border-color:#2a3347}
  .btn.danger{background:#2a1618;color:#ffd6d6;border-color:#3a2325}

  /* ===== Modal base ===== */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);z-index:40;padding:6px;} /* menos margen */
  .modal.show{display:grid}
  .box{
    width: clamp(980px, 96vw, 1800px);     /* ancho grande, casi toda la pantalla */
    max-height: 96vh;                      /* más alto */
    overflow: hidden;                      /* evita barras dobles */
    background: var(--surface);
    border:1px solid var(--line);
    border-radius:18px;
    padding:14px;
    display:flex;
    flex-direction:column;
  }

  /* Botón X en modales */
  .modal .box{ position: relative; }
  .modal .btn-x{
    position:absolute; top:10px; right:10px;
    width:36px; height:36px; border-radius:10px;
    border:1px solid var(--line); background:#10141b; color:#dfe7f3;
    display:grid; place-items:center; cursor:pointer;
  }
  .modal .btn-x:hover{ background:#17202b; }

  /* ===== Builder ===== */
  .builder{
    display:grid; grid-template-columns:1fr 460px; /* derecha un poquito más ancha */
    gap:16px; align-items:stretch;
    min-height:460px;
    height: calc(96vh - 90px); /* ocupa el alto del modal sin desbordar */
  }
  @media (max-width:1100px){
    .builder{grid-template-columns:1fr}
    .right-pane{order:2}
  }

  .search{display:flex;gap:8px;margin:6px 0 10px}
  .search input{flex:1;background:#151821;border:1px solid var(--line);color:#fff;border-radius:10px;padding:12px 12px}
  .cats{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#151821;color:#e8eefc;cursor:pointer}
  .chip.active{background:#1f2633;border-color:#2a3347}

  /* Solo la grilla scrollea (una barra) */
  .products{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:10px;
    max-height: none;
    overflow-y:auto;
    overflow-x:hidden;
    flex: 1 1 auto;
  }
  @media (max-width:1100px){ .products{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:560px){  .products{grid-template-columns:1fr} }
  @media (min-width:1200px){ .products{grid-template-columns:repeat(4, minmax(200px,1fr));} }
  @media (min-width:1600px){ .products{grid-template-columns:repeat(5, minmax(200px,1fr));} }

  .card{background:#151821;border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;justify-content:space-between;align-items:center;gap:10px;min-height:78px}
  .thumb{width:48px;height:48px;border-radius:10px;background:#0f1116;border:1px solid var(--line);display:grid;place-items:center;color:#ffd9a8;overflow:hidden;flex:0 0 48px}
  .thumb img{width:100%;height:100%;object-fit:cover}

  .right-pane{
    background:#151821;border:1px solid var(--line);border-radius:12px;padding:10px;
    min-width:460px; max-height:none; overflow-y:auto; overflow-x:hidden;
    display:flex; flex-direction:column; gap:10px;
  }
  .miniList{display:flex;flex-direction:column;gap:8px;max-height:36vh;overflow:auto}
  .miniItem{display:grid;grid-template-columns:1fr 100px 32px;align-items:center;gap:8px;background:#11141b;border:1px solid var(--line);border-radius:10px;padding:8px}

  /* ===== Tarjetas Llevar/Delivery ===== */
  .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:1200px){.cards{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:900px){ .cards{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:600px){ .cards{grid-template-columns:1fr}}
  .card-tile{background:#151821;border:1px solid var(--line);border-radius:22px;padding:12px;min-height:128px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;transition:.15s}
  .card-tile:hover{transform:translateY(-2px)}
  .card-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .card-badge{background:#0ea5e9;color:#082431;border:none;border-radius:999px;padding:3px 10px;font-weight:800;white-space:nowrap}
  .card-foot{display:flex;justify-content:space-between;align-items:center;opacity:.95;gap:10px;flex-wrap:wrap}
  .card-actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
  .btn.icon{width:38px;height:38px;display:grid;place-items:center;border-radius:10px}

  /* ===== Inventario (drawer) ===== */
  .drawer{position:fixed;right:0;top:0;height:100%;width:min(1400px,98vw);background:#0f1218;border-left:1px solid var(--line);box-shadow:-10px 0 30px rgba(0,0,0,.3);transform:translateX(110%);transition:.2s;z-index:50;display:flex;flex-direction:column;overflow:hidden}
  .drawer.show{transform:none}
  .drawer .header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);background:#0f1218;gap:8px;flex-wrap:wrap}
  .drawer .header .pill{min-height:40px}

  /* Cabecera 10 columnas (desktop) */
  .inv-grid{padding:12px;display:grid;grid-template-columns:2fr 110px 130px 150px 1.4fr 1.2fr 110px 110px 110px 90px;gap:8px;align-items:center}
  .inv-grid.head{font-weight:800;opacity:.8}

/* Fila inventario */
  .inv-row{background:#121622;border:1px solid var(--line);border-radius:12px;padding:8px;display:grid;grid-template-columns:2fr 110px 130px 150px 1.4fr 1.2fr 110px 110px 110px 90px;gap:8px;align-items:center}
  .inv-row input,.inv-row select{width:100%;background:#0f1218;border:1px solid var(--line);border-radius:10px;padding:10px;color:#fff}
  .avatar{width:42px;height:42px;border-radius:10px;overflow:hidden;border:1px solid var(--line);background:#0f1116;display:grid;place-items:center;flex:0 0 42px}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .pill.btn{white-space:nowrap}

  /* ===== Historial ===== */
  .history{position:fixed;left:0;top:0;height:100%;width:min(920px,98vw);background:#0f1218;border-right:1px solid var(--line);box-shadow:10px 0 30px rgba(0,0,0,.3);transform:translateX(-110%);transition:.2s;z-index:60;display:flex;flex-direction:column}
  .history.show{transform:none}
  .history .header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);background:#0f1218;gap:8px;flex-wrap:wrap}
  table.hist{width:100%;border-collapse:collapse}
  table.hist th,table.hist td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
  table.hist th{opacity:.8}
  .right{text-align:right}

  /* ===== Ticket (58mm) ===== */
  #ticket{width:var(--ticket-width);padding:6mm;font-family:ui-monospace,Menlo,Consolas,monospace;color:#000;background:#fff;display:none;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  #ticket.show{display:block}
  #t-logo{display:flex;justify-content:center;align-items:center;margin-bottom:2mm}
  #t-logo img{height:130px;max-width:100%;object-fit:contain}
  #t-brand{margin:0 0 1mm;font-size:14pt;text-align:center}
  #t-tagline{margin:0 0 2mm;font-size:9pt;text-align:center;opacity:.9}
  #t-kind{font-size:12pt;font-weight:700;margin:2mm 0}
  #ticket .small{font-size:9pt}
  #ticket .row{display:flex;justify-content:space-between;align-items:baseline;gap:6px}
  #ticket table{width:100%;border-collapse:collapse;margin:2mm 0;table-layout:fixed}
  #ticket th,#ticket td{font-size:10pt;padding:1mm 0;border-bottom:1px dashed #ddd}
  #ticket th:nth-child(1),#ticket td:nth-child(1){width:20%;text-align:left;padding-right:4mm;white-space:nowrap}
  #ticket th:nth-child(2),#ticket td:nth-child(2){width:54%;text-align:left;padding:1mm 1mm;padding-left:3mm;word-wrap:break-word;overflow-wrap:anywhere}
  #ticket th:nth-child(3),#ticket td:nth-child(3){width:26%;text-align:right;white-space:nowrap;padding-left:2mm}
  #ticket .right{text-align:right}
  #ticket .center{text-align:center}
  #ticket .total{font-weight:700}
  @media print{
    @page{ size: var(--ticket-width) auto; margin:0; }
    html,body{ background:#fff !important; }
    body > :not(#ticket){ display:none !important; }
    #ticket{display:block !important;position:fixed !important; top:0; left:0; width:var(--ticket-width) !important;margin:0 !important;background:#fff !important;color:#000 !important; z-index:999999 !important;}
  }

  /* ===== Panel derecho cómodo ===== */
  .right-pane *{ min-width:0; }
  .right-pane .actions{ display:flex; flex-wrap:wrap; gap:8px; }
  #deliveryFields{ display:flex; flex-wrap:wrap; gap:8px; }
  #deliveryFields .pill{ flex: 1 1 calc(50% - 4px); min-width:0; }
  #deliveryFields .pill:last-child{ flex-basis:100%; }
  @media (max-width:1200px){
    .right-pane{ min-width:auto; }
    #deliveryFields .pill{ flex-basis:100%; }
  }

  /* ===== FX / Toasts ===== */
  .fx-overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);backdrop-filter:blur(3px);z-index:1000;animation:.2s fadeIn both}
  .fx-overlay.show{display:grid}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  .fx-card{width:min(540px,92vw);background:#0f1117;border:1px solid var(--line);border-radius:22px;padding:18px;text-align:center;box-shadow:0 30px 80px rgba(0,0,0,.45);animation:.24s popIn both}
  @keyframes popIn{from{transform:scale(.92);opacity:0}to{transform:scale(1);opacity:1}}
  .fx-icon{width:120px;height:120px;border-radius:50%;margin:8px auto 14px;display:grid;place-items:center;border:2px solid var(--line);position:relative}
  .fx-icon.ok{background:radial-gradient(60% 60% at 50% 50%, rgba(34,197,94,.18), transparent)}
  .fx-icon.warn{background:radial-gradient(60% 60% at 50% 50%, rgba(245,158,11,.18), transparent)}
  .fx-icon.danger{background:radial-gradient(60% 60% at 50% 50%, rgba(239,68,68,.18), transparent)}
  .fx-title{font-size:22px;font-weight:900;margin:2px 0 4px}
  .fx-sub{opacity:.8;margin-bottom:14px}
  .fx-actions{display:flex;justify-content:center;gap:8px;flex-wrap:wrap}
  .fx-actions .btn{min-width:130px}
  .draw{stroke-dasharray:150; stroke-dashoffset:150; animation:draw .8s ease forwards .2s}
  @keyframes draw{to{stroke-dashoffset:0}}
  .confetti{position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:1200}
  .confetti i{position:absolute;width:8px;height:14px;border-radius:2px;opacity:0;transform:translateY(-20vh) rotate(0deg);animation:drop 1.2s ease-in forwards}
  @keyframes drop{0%{opacity:0;transform:translateY(-20vh) rotate(0)}10%{opacity:1}100%{opacity:1;transform:translateY(110vh) rotate(360deg)}}
  .toaster{position:fixed; top:14px; right:14px; z-index:1100; display:flex; flex-direction:column; gap:8px}
  .toast{background:#121420;border:1px solid var(--line);color:#fff;padding:10px 12px;border-radius:12px;min-width:260px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:flex;align-items:center;gap:10px;animation:slideIn .25s ease both}
  @keyframes slideIn{from{opacity:0; transform:translateY(-8px)} to{opacity:1; transform:translateY(0)}}
  .toast.ok{border-color:rgba(34,197,94,.35)}
  .toast.warn{border-color:rgba(245,158,11,.35)}
  .toast.danger{border-color:rgba(239,68,68,.35)}

  /* ======= MEJORAS MOBILE ======= */
  @media (max-width:900px){
    .actions .btn{flex:1 1 calc(50% - 4px)}
  }
  @media (max-width:520px){
    .top{gap:8px;flex-wrap:wrap}
    .top > div:last-child{display:flex;flex-wrap:wrap;gap:8px}
    .pill, .btn{padding:10px 12px}
    .item, .miniItem{grid-template-columns:1fr 88px 32px}
    .qty button{min-width:34px;height:34px}
    .actions .btn{flex:1 1 100%}
    .list, .miniList{max-height:52vh}
    .right-pane{max-height:62vh}
  }

  /* Inventario RESPONSIVE */
  @media (max-width:700px){
    .inv-grid.head{display:none}
    .inv-body{padding:12px;gap:12px}
    .inv-row{grid-template-columns:1fr; gap:10px;}
    .inv-row > div,.inv-row > select,.inv-row > button,.inv-row > input{min-width:0}
    .inv-row .save, .inv-row .del{width:100%;}
  }
  
/* ====== Tarjeta de producto: título arriba, botón abajo ====== */
.products{
  grid-auto-rows: minmax(170px, auto);  /* alto mínimo cómodo */
  align-content: start;                  /* no rellenar verticalmente */
  align-items: start;                    /* que las cards no crezcan a la fuerza */
}

.card{
  display:flex;
  flex-direction:column;          /* apila contenido vertical */
  justify-content:space-between;  /* empuja el botón al fondo */
  align-items:stretch;
  gap:10px;
  height:auto;
  min-height:170px;               /* tamaño “chiquito” estándar */
}

/* Encabezado de la tarjeta (thumb + textos) */
.card > div:first-child{
  display:flex !important;        /* asegura fila para thumb+textos */
  align-items:flex-start;
  gap:10px;
}

/* Nombre y precio: que quebren bonito y no se monten */
.card > div:first-child > div{
  overflow-wrap:anywhere;         /* permite cortar palabras largas */
  line-height:1.15;
}
.card > div:first-child > div > div:first-child{
  font-weight:700;
  display:-webkit-box;            /* clamp a 2 líneas */
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

/* Botón Agregar a lo ancho y centrado */
.card .btn.primary{
  width:100%;
  justify-content:center;
  align-self:stretch;
}

/* Opcional: tarjetas aún más altas en pantallas grandes */
@media (min-width:1400px){
  .products{ grid-auto-rows: minmax(190px, auto); }
  .card{ min-height:190px; }
}

/* ===== Builder: columna izquierda como contenedor flex ===== */
.builder > div:first-child{
  display:flex;
  flex-direction:column;
  min-height:0;      /* permite que .products haga scroll */
}

/* La grilla de productos ocupa el espacio sobrante y scrollea */
.products{
  flex:1 1 auto;
  min-height:0;
  overflow-y:auto;                /* scroll solo vertical en productos */
  overflow-x:hidden;
  scrollbar-gutter: stable;       /* reserva espacio para la barra */
  padding-right: 7px;             /* espacio extra junto a la barra */
}

/* Asegura que contenedores padres no tapen el scroll interno */
.box, .builder, .right-pane{ min-height:0; }

/* ===== Scrollbar BONITA y más ancha ===== */
/* Firefox */
.products{
  scrollbar-width: thin;
  scrollbar-color: var(--accent) transparent;
}
/* WebKit (Chrome, Edge, Safari) */
.products::-webkit-scrollbar{
  width: 20px;                    /* más ancha */
}
.products::-webkit-scrollbar-track{
  background: transparent;
  margin: 4px;                    /* margen arriba/abajo */
}
.products::-webkit-scrollbar-thumb{
  background: linear-gradient(180deg, var(--accent), var(--accent2));
  border-radius: 999px;
  border: 3px solid #121318;      /* crea “espacio” entre grid y barra */
  box-shadow: 0 0 6px rgba(255,122,0,.45);
}
.products::-webkit-scrollbar-thumb:hover{
  background: linear-gradient(180deg, var(--accent2), var(--accent));
  box-shadow: 0 0 10px rgba(255,179,71,.7);
}

/* ===== MÓVIL (siempre 2 columnas, compacto y SIN adaptarse a 1) ===== */
@media (max-width: 560px){
  .products{
    grid-template-columns: repeat(2, minmax(0,1fr)) !important; /* 2 columnas fijo */
    grid-auto-rows: minmax(140px, auto); /* cards más compactas */
    gap: 8px;
  }
  .card{
    min-height:140px;
    padding:8px;
    gap:6px;
  }
  .thumb, .card .thumb{
    width:40px; height:40px;
  }
  .card .btn.primary{
    padding:8px;
    font-size:.9rem;
  }
  .card > div:first-child > div{
    font-size:.95rem;
  }
}

.pill.icon{
  padding:8px; width:40px; height:40px;
  display:grid; place-items:center; border-radius:999px;
}
.pill.icon.info{
  background:linear-gradient(135deg, var(--info), #7aa8ff);
  color:#06122b; border:none; font-weight:800;
}
.pill.icon.info i{ font-size:16px; }

/* === Pedido actual (Mesa, Para llevar, Delivery) === */
/* Mostrar todos los botones normales */
.side .actions .btn { 
  display: inline-flex !important; 
  width: auto;
  padding: 8px 12px;
  font-size: 1rem;
  border-radius: 8px;
}


/* ===== MODAL DE PAGO BONITO ===== */
.pay-grid{
  display:grid; gap:12px;
  grid-template-columns: 1.2fr .8fr;
}
@media (max-width:900px){ .pay-grid{ grid-template-columns:1fr; } }

.pay-card{
  background:#10131a;border:1px solid var(--line);
  border-radius:14px; padding:12px;
}
.pay-card h5{ margin:0 0 10px; font-size:1rem; opacity:.9 }

.pay-row{ display:grid; gap:8px; grid-template-columns:1fr 1fr; }
.pay-row > * { min-width:0 }
@media (max-width:700px){ .pay-row{ grid-template-columns:1fr } }

.input{
  display:flex; align-items:center; gap:8px;
  background:#0e1117; border:1px solid var(--line);
  padding:10px 12px; border-radius:10px; color:#fff;
}
.input input{ flex:1; background:transparent; border:0; outline:0; color:#fff; }
.input select{ flex:1; background:#0e1117; border:0; outline:0; color:#fff; }

.pay-tabs{ display:flex; gap:8px; flex-wrap:wrap; }
.pay-tab{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 12px; border-radius:12px;
  background:#131722; border:1px solid var(--line);
  cursor:pointer; user-select:none;
}
.pay-tab i{ font-size:1rem }
.pay-tab.active{
  background:linear-gradient(135deg, var(--accent), var(--accent2));
  color:#261106; border:none; font-weight:800;
}

.total-box{
  background:#0b1410;
  border:1px solid rgba(34,197,94,.35);
  padding:12px; border-radius:12px;
}
.total-row{ display:flex; justify-content:space-between; margin:6px 0; gap:10px; }
.total-row.big{ font-size:1.25rem; font-weight:900; }

.note{ font-size:.9rem; opacity:.8; }

/* === Mover Mesas (grid) === */
.tables-grid{
  display:grid;
  grid-template-columns:repeat(6, minmax(90px,1fr));
  gap:10px; margin-top:8px;
}
.tcell{
  background:#0f1118; border:1px solid var(--line);
  border-radius:14px; padding:10px; min-height:84px;
  display:flex; flex-direction:column; justify-content:space-between;
  user-select:none; cursor:grab;
}
.tcell.dragging{ opacity:.6; }
.tnum{ font-weight:900; font-size:1.05rem; }
.tmeta{ font-size:.86rem; opacity:.9; }
.busy{ outline:2px solid rgba(14,165,233,.35); }
.drop-ok{ box-shadow:0 0 0 2px #3b82f6 inset; }

/* ===== Caja (PIN numérico) ===== */
.pill.icon.safe{
  background:linear-gradient(135deg,#ffd166,#ff7a00);
  color:#2b1506; border:none; font-weight:800;
}
.pill.icon.safe i{ font-size:16px; }

#modalCaja .box{ width:min(420px,96vw); }

.pin-dots{
  display:flex; justify-content:center; gap:8px;
  margin:10px 0 12px;
}
.pin-dots span{
  width:12px; height:12px; border-radius:50%;
  background:#1f2431; border:1px solid var(--line);
}
.pin-dots span.on{
  background:#3b82f6; border-color:rgba(59,130,246,.7);
}

.pin-msg{ text-align:center; min-height:20px; }

.numpad{
  display:grid; grid-template-columns:repeat(3,84px);
  gap:10px; justify-content:center;
}
.numpad button{
  height:60px; border-radius:12px;
  border:1px solid var(--line);
  background:#151821; color:#fff; font-size:1.1rem; cursor:pointer;
}
.numpad button.primary{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#261106; border:none; font-weight:800;
}
.numpad button.ghost{ opacity:.75; }

.shake{ animation:shake .25s linear; }
@keyframes shake{
  0%{transform:translateX(0)}25%{transform:translateX(-6px)}
  50%{transform:translateX(6px)}75%{transform:translateX(-6px)}
  100%{transform:translateX(0)}
}


</style>
</head>
<body>
  <header class="top">
    <div class="brand">Lindero <b>Grill</b> — POS</div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <span class="pill money" id="soldToday"><i class="fa-solid fa-chart-line"></i> Hoy vendido: S/ 0.00</span>
      <button class="pill btn" id="btnHistory"><i class="fa-solid fa-clock-rotate-left"></i> Historial</button>
      <button class="pill btn" id="btnInventory"><i class="fa-solid fa-boxes-stacked"></i> Inventario</button>
      <span class="pill" id="clock">--:--</span>
      <a class="pill" href="/logout"><i class="fa-solid fa-right-from-bracket"></i> Salir</a>
    </div>
  </header>

  <main class="wrap">
    <nav class="subtabs" id="modes">
  <button class="tab active" data-mode="mesa"><i class="fa-solid fa-chair"></i> Mesa</button>
  <button class="tab" data-mode="llevar"><i class="fa-solid fa-bag-shopping"></i> Para llevar</button>
  <button class="tab" data-mode="delivery"><i class="fa-solid fa-motorcycle"></i> Delivery</button>

  <!-- NUEVO: aparece solo en vista MESAS (lo manejamos por JS) -->
  <button class="pill btn warn" id="btnMoveTables" style="display:none; margin-left:8px">
    <i class="fa-solid fa-up-down-left-right"></i> Mover mesas
  </button>
</nav>

    <!-- MESAS -->
    <section class="grid2" id="view-mesa">
      <div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap">
          <span class="pill">PISO 1</span>
          <span class="muted">Toca una mesa para ver acciones • Usa el <b>lápiz</b> para editar el pedido</span>
        </div>
        <div class="board" id="board"></div>
      </div>
      <aside class="side">
        <h3><i class="fa-solid fa-receipt"></i> Pedido actual</h3>
        <div id="mesaLabel" class="muted">Sin mesa seleccionada</div>
        <div class="list" id="cart"></div>
        <div class="tot">
          <div class="row"><span>Subtotal</span><span id="sub">S/ 0.00</span></div>
          <div class="row total"><span>Total</span><span id="tot">S/ 0.00</span></div>
        </div>
        <div class="actions">
          <button class="btn" id="guardar"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
          <button class="btn warn" id="precuenta"><i class="fa-solid fa-list-check"></i> Precuenta</button>
          <button class="btn ok" id="cobrar"><i class="fa-solid fa-money-bill-wave"></i> Cobrar</button>
          <button class="btn" id="imprimir"><i class="fa-solid fa-print"></i> Imprimir</button>
          <button class="btn danger" id="liberar"><i class="fa-solid fa-broom"></i> Liberar</button>
        </div>
      </aside>
    </section>

    <!-- LLEVAR -->
    <section class="grid2" id="view-llevar" style="display:none">
      <div>
        <div class="actions" style="margin:10px 0">
          <button class="btn primary" id="btnNuevaLlevar"><i class="fa-solid fa-plus"></i> Nueva orden</button>
        </div>
        <div class="cards" id="listLlevar"></div>
      </div>
      <aside class="side">
        <h3><i class="fa-solid fa-receipt"></i> Pedido actual</h3>
        <div id="llevarLabel" class="muted">Sin orden seleccionada</div>
        <div class="list" id="llevarCart"></div>
        <div class="tot">
          <div class="row"><span>Subtotal</span><span id="llevarSub">S/ 0.00</span></div>
          <div class="row total"><span>Total</span><span id="llevarTot">S/ 0.00</span></div>
        </div>
        <div class="actions">
          <button class="btn" id="llevarEdit"><i class="fa-solid fa-pen"></i> Editar</button>
          <button class="btn ok" id="llevarCobrar"><i class="fa-solid fa-money-bill-wave"></i> Cobrar</button>
          <button class="btn" id="llevarImprimir"><i class="fa-solid fa-print"></i> Imprimir</button>
          <button class="btn danger" id="llevarCancelar"><i class="fa-solid fa-trash"></i> Cancelar</button>
        </div>
      </aside>
    </section>

    <!-- DELIVERY -->
    <section class="grid2" id="view-delivery" style="display:none">
      <div>
        <div class="actions" style="margin:10px 0">
          <button class="btn primary" id="btnNuevaDelivery"><i class="fa-solid fa-plus"></i> Nuevo delivery</button>
        </div>
        <div class="cards" id="listDelivery"></div>
      </div>
      <aside class="side">
        <h3><i class="fa-solid fa-truck-fast"></i> Pedido actual</h3>
        <div id="deliveryLabel" class="muted">Sin delivery seleccionado</div>
        <div class="list" id="deliveryCart"></div>
        <div class="tot">
          <div class="row"><span>Subtotal</span><span id="deliverySub">S/ 0.00</span></div>
          <div class="row total"><span>Total</span><span id="deliveryTot">S/ 0.00</span></div>
        </div>
        <div class="actions">
          <button class="btn" id="deliveryEdit"><i class="fa-solid fa-pen"></i> Editar</button>
          <button class="btn ok" id="deliveryCobrar"><i class="fa-solid fa-money-bill-wave"></i> Cobrar</button>
          <button class="btn" id="deliveryImprimir"><i class="fa-solid fa-print"></i> Imprimir</button>
          <button class="btn danger" id="deliveryCancelar"><i class="fa-solid fa-trash"></i> Cancelar</button>
        </div>
      </aside>
    </section>
  </main>

  <!-- TICKET -->
  <section id="ticket" aria-hidden="true">
    <div id="t-header">
      <div id="t-logo"><img id="t-logo-img" alt="Lindero Grill"></div>
      <h2 id="t-brand">Lindero Grill</h2>
      <div class="center small" id="t-tagline">"El lugar del auténtico sabor"</div>
    </div>
    <h3 id="t-kind" class="center" style="margin:2mm 0 1mm">— —</h3>
    <div class="row small"><span>Comanda:</span><span id="t-num">—</span></div>
    <div class="row small"><span>Fecha-Hora:</span><span id="t-date">—</span></div>
    <table>
      <thead><tr><th>Cant.</th><th>Producto</th><th class="right">Sub.T</th></tr></thead>
      <tbody id="t-body"></tbody>
    </table>
    <div class="row small total"><span>Total:</span><span id="t-total">S/ 0.00</span></div>
	<div id="t-payRows" class="small"></div>
    <div class="center small" id="t-footer" style="margin-top:2mm">¡Gracias por su compra!</div>
  </section>

  <!-- MODAL BUILDER -->
<div class="modal" id="modalBuild">
  <div class="box">
    <button class="btn-x" aria-label="Cerrar" data-close-modal>&times;</button>
    <h4 id="buildTitle"><i class="fa-solid fa-list-ul"></i> Nueva orden</h4>
    <div class="builder">
      <div>
        <div class="search">
          <input id="q" placeholder="Buscar producto…">
          <button class="btn" id="clearQ"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="cats" id="cats"></div>
        <div class="products" id="grid"></div>
      </div>
      <div class="right-pane">
        <div class="pill" id="buildContext">—</div>
        <div class="miniList" id="mini"></div>
        <div class="tot">
          <div class="row"><span>Subtotal</span><span id="bsub">S/ 0.00</span></div>
          <div class="row total"><span>Total</span><span id="btot">S/ 0.00</span></div>
        </div>
        <div class="f" id="deliveryFields" style="display:none">
          <span class="pill"><i class="fa-solid fa-user"></i><input id="cliName" placeholder="Cliente" style="background:transparent;border:none;outline:none;color:#fff"></span>
          <span class="pill"><i class="fa-solid fa-phone"></i><input id="cliPhone" placeholder="Teléfono" style="background:transparent;border:none;outline:none;color:#fff"></span>
          <span class="pill" style="flex:1 1 100%"><i class="fa-solid fa-location-dot"></i><input id="cliAddr" placeholder="Dirección" style="background:transparent;border:none;outline:none;color:#fff;width:100%"></span>
        </div>
        <div class="actions">
          <button class="btn" id="bCancel">Cancelar</button>
          <button class="btn" id="bSave"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
          <button class="btn warn" id="bPre"><i class="fa-solid fa-list-check"></i> Precuenta</button>
          <button class="btn ok" id="bPay"><i class="fa-solid fa-money-bill"></i> Cobrar</button>
          <button class="btn" id="bPrint"><i class="fa-solid fa-print"></i> Imprimir</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PAGO (nuevo) -->
<div class="modal" id="modalPay">
  <div class="box">
    <button class="btn-x" aria-label="Cerrar" data-close-modal>&times;</button>
    <h4><i class="fa-solid fa-cash-register"></i> Cobrar</h4>

    <div class="pay-grid">
      <!-- Columna izquierda: Datos del cliente -->
      <div class="pay-card">
        <h5><i class="fa-solid fa-user"></i> Datos del cliente</h5>
        <div class="pay-row">
          <div class="input"><i class="fa-solid fa-id-card"></i><input id="payDni" placeholder="DNI"></div>
          <div class="input"><i class="fa-solid fa-user"></i><input id="payName" placeholder="Nombre y apellido"></div>
        </div>
        <div class="pay-row">
          <div class="input"><i class="fa-solid fa-phone"></i><input id="payPhone" placeholder="Teléfono (opcional)"></div>
          <div class="input"><i class="fa-solid fa-envelope"></i><input id="payEmail" placeholder="Email (opcional)"></div>
        </div>
      </div>

      <!-- Columna derecha: Pago -->
      <div class="pay-card">
        <h5><i class="fa-solid fa-wallet"></i> Método de pago</h5>
        <div class="pay-tabs" id="payTabs">
          <div class="pay-tab active" data-method="cash"><i class="fa-solid fa-money-bill-wave"></i> Efectivo</div>
          <div class="pay-tab" data-method="qr"><i class="fa-solid fa-qrcode"></i> Yape / Plin</div>
          <div class="pay-tab" data-method="visa"><i class="fa-brands fa-cc-visa"></i> Visa</div>
          <div class="pay-tab" data-method="mastercard"><i class="fa-brands fa-cc-mastercard"></i> MasterCard</div>
        </div>

        <!-- guardamos método real aquí (compat con tu JS actual) -->
        <select id="payMethod" style="display:none">
          <option value="cash" selected>Efectivo</option>
          <option value="qr">Yape/Plin</option>
          <option value="visa">Visa</option>
          <option value="mastercard">MasterCard</option>
        </select>

        <div style="height:10px"></div>

        <div class="input"><i class="fa-solid fa-cash-register"></i>
          <input type="number" id="payAmount" step="0.01" min="0" placeholder="Monto recibido">
        </div>

        <div class="total-box" style="margin-top:10px">
          <div class="total-row"><span>Total a pagar</span><b id="payTotal">S/ 0.00</b></div>
          <div class="total-row"><span>Recibido</span><b id="payIn">S/ 0.00</b></div>
          <div class="total-row big"><span>Cambio</span><span id="payChange">S/ 0.00</span></div>
          <div class="note" id="payHint"></div>
        </div>
      </div>
    </div>

    <div class="actions" style="margin-top:12px">
      <button class="btn" id="cancelPay">Cancelar</button>
      <button class="btn ok" id="confirmPay">Confirmar</button>
    </div>
  </div>
</div>

<!-- MODAL: Mover Mesas -->
<div class="modal" id="modalMove">
  <div class="box">
    <button class="btn-x" aria-label="Cerrar" data-close-modal>&times;</button>
    <h4><i class="fa-solid fa-up-down-left-right"></i> Mover mesas</h4>
    <p class="muted" style="margin:6px 0 10px">
      Arrastra una mesa y suéltala sobre otra para <b>intercambiar sus pedidos de hoy</b>.
    </p>
    <div id="tablesGrid" class="tables-grid"></div>
  </div>
</div>

<!-- MODAL: Caja (PIN) -->
<div class="modal" id="modalCaja">
  <div class="box">
    <button class="btn-x" aria-label="Cerrar" data-close-modal>&times;</button>
    <h4><i class="fa-solid fa-vault"></i> Caja</h4>

    <div class="pin-dots" id="pinDots">
      <span></span><span></span><span></span><span></span>
    </div>
    <p id="pinMsg" class="muted pin-msg"></p>

    <div class="numpad" id="pinPad" role="group" aria-label="Teclado PIN">
      <button type="button" data-k="1">1</button>
      <button type="button" data-k="2">2</button>
      <button type="button" data-k="3">3</button>
      <button type="button" data-k="4">4</button>
      <button type="button" data-k="5">5</button>
      <button type="button" data-k="6">6</button>
      <button type="button" data-k="7">7</button>
      <button type="button" data-k="8">8</button>
      <button type="button" data-k="9">9</button>
      <button type="button" class="ghost" data-k="x" title="Borrar">
        <i class="fa-solid fa-delete-left"></i>
      </button>
      <button type="button" data-k="0">0</button>
      <button type="button" class="primary" data-k="ok" title="Ingresar">
        <i class="fa-solid fa-right-to-bracket"></i> Ingresar
      </button>
    </div>
  </div>
</div>

  <!-- INVENTARIO -->
  <aside class="drawer" id="inv">
    <div class="header">
      <h3 style="margin:0"><i class="fa-solid fa-boxes-stacked"></i> Inventario</h3>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="invSearch" class="pill" placeholder="Filtrar…" style="background:#0f1218;border:1px solid var(--line);color:#fff;padding:10px;min-width:220px">
        <button class="pill btn" id="addProduct"><i class="fa-solid fa-plus"></i> Nuevo producto</button>
        <button class="pill btn" id="closeInv"><i class="fa-solid fa-xmark"></i> Cerrar</button>
      </div>
    </div>
    <div class="inv-grid head">
  <div>Producto</div>
  <div>Precio</div>
  <div>Stock (base)</div>
  <div>Unidad</div>
  <div>Imagen</div>
  <div>Guardar</div>
  <div>Eliminar</div>
  <div>Info</div>
</div>
    <div id="invBody" class="inv-body"></div>
  </aside>

  <!-- HISTORIAL -->
  <aside class="history" id="history">
    <div class="header">
      <h3 style="margin:0"><i class="fa-solid fa-clock-rotate-left"></i> Historial de ventas</h3>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input type="date" id="hDay" class="pill" style="background:#0f1218;border:1px solid var(--line);color:#fff;padding:10px">
        <button class="pill btn" id="hReload"><i class="fa-solid fa-rotate"></i> Cargar</button>
        <button class="pill btn" id="hXlsx"><i class="fa-solid fa-file-excel"></i> Descargar Excel</button>
        <button class="pill btn" id="hClose"><i class="fa-solid fa-xmark"></i> Cerrar</button>
      </div>
    </div>
    <div style="padding:12px">
      <table class="hist" id="histTable">
        <thead><tr><th>Fecha</th><th class="right">Total vendido</th><th class="right">Comprobantes</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </aside>

  <!-- FX Roots -->
  <div id="fx" class="fx-overlay" aria-hidden="true">
    <div class="fx-card">
      <div id="fxIcon" class="fx-icon ok"></div>
      <div id="fxTitle" class="fx-title">¡Listo!</div>
      <div id="fxSub" class="fx-sub">Acción realizada con éxito.</div>
      <div id="fxBtns" class="fx-actions"></div>
    </div>
  </div>
  <div id="toaster" class="toaster"></div>
  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
/* ========= Firebase ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, onSnapshot,
         serverTimestamp, query, where, Timestamp, runTransaction, orderBy, deleteDoc, writeBatch } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAqP22yZtwqrhu40hpL4n8gf02dsf74NLY",
  authDomain: "lindero-grill-pos.firebaseapp.com",
  projectId: "lindero-grill-pos",
  storageBucket: "lindero-grill-pos.firebasestorage.app",
  messagingSenderId: "611892354863",
  appId: "1:611892354863:web:27512bb7b7551244090bda"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const st   = getStorage(app);

/* ========= Utils ========= */
const $ = s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const fmt = n=>'S/ '+Number(n||0).toFixed(2);
function methodLabel(m){
  const map = { cash:'Efectivo', qr:'Yape/Plin', visa:'Visa', mastercard:'MasterCard' };
  return map[m] || (m ? String(m) : '—');
}
function nowStr(){ const d=new Date(); return d.toLocaleDateString()+' '+d.toLocaleTimeString().slice(0,8); }
function ymd(d){
  const off = d.getTimezoneOffset();
  const local = new Date(d.getTime() - off*60*1000);
  return local.toISOString().slice(0,10);
}
setInterval(()=>$('#clock').textContent=nowStr(),1000);
await new Promise(res=>onAuthStateChanged(auth,u=>u?res():signInAnonymously(auth)));
/* ==== Unidades y formateo ==== */
const U_KINDS = {
  unit: 'UNIDADES',
  volume_ml: 'VOLUMEN (ml)',
  chicken: 'POLLO (enteros)'
};

// Convierte volumen (ml) a "X L + Y ml"
function formatMl(mlTotal){
  mlTotal = Math.max(0, Math.floor(Number(mlTotal||0)));
  const L = Math.floor(mlTotal/1000);
  const ml = mlTotal % 1000;
  if (L && ml) return `${L} L + ${ml} ml`;
  if (L) return `${L} L`;
  return `${ml} ml`;
}

// Descompone pollo (enteros en decimal) a 1, 1/2, 1/4, 1/8
function formatChicken(ch){
  let rest = Math.max(0, Number(ch||0));
  const enteros = Math.floor(rest); rest -= enteros;
  let octavos = Math.round(rest * 8);
  const halves   = Math.floor(octavos / 4);  octavos = octavos % 4; // 4/8 = 1/2
  const quarters = Math.floor(octavos / 2);  octavos = octavos % 2; // 2/8 = 1/4
  const eighths  = octavos; // 1/8
  const partes = [];
  if (enteros) partes.push(`${enteros} pollo${enteros>1?'s':''}`);
  if (halves) partes.push(`${halves} ${halves>1?'medios':'1/2'}`);
  if (quarters) partes.push(`${quarters} ${quarters>1?'cuartos':'1/4'}`);
  if (eighths) partes.push(`${eighths} ${eighths>1?'octavos':'1/8'}`);
  return partes.length ? partes.join(' + ') : '0';
}

// Renderiza “restante” legible según tipo
function humanStock(p){
  const s = Number(p.stock||0);
  const k = p.uKind || 'unit';

  if(k==='ml'){ 
    const L = Math.floor(s/1000);
    const ml = s%1000;
    return (L?`${L} L`:'') + (ml?`${ml} ml`: L?'':'0 ml');
  }
  if(k==='chicken'){ 
    const entero = Math.floor(s);
    const resto = s - entero;
    const fraccion = resto>0 ? ` + ${Math.round(resto*8)}/8` : '';
    return `${entero} pollos${fraccion}`;
  }
  return `${s} unid`;
}


/* ========= Constantes ========= */
const IGV_RATE = 0;
let MODE='mesa', FLOOR='piso1';
let CURRENT_TABLE=null;
let CART={}; let PRODUCTS=[], CATS=[];
let unsubTables=null, unsubOrdersToday=null;

/* ========= Ticket / Boleta ========= */
const TICKET_LOGO_URL = 'static/logo-ticket.png';
const BUSINESS_NAME   = "Lindero Grill";
const BUSINESS_TAGLINE= "El lugar del auténtico sabor";

// ===== CONSUMIR RECETAS DESDE UNA VENTA =====
// items: [{id,name,price,qty}, ...] (usa el id del product)
// items: [{ id, name, price, qty }]
async function consumeRecipesFromSale(items){
  if(!Array.isArray(items) || !items.length) return;

  // 1) Cargar productos de la venta (para leer su receta)
  const ids = [...new Set((items||[]).map(it => it.id))];
  const proms = ids.map(id => getDoc(doc(db,'products',id)));
  const docs  = await Promise.all(proms);
  const PMAP  = {};
  docs.forEach(d => { if(d.exists()) PMAP[d.id] = { id:d.id, ...d.data() }; });

  // 2) Acumular consumo por ingrediente
  //    chicken -> unidades de pollo (decimales); bebidas -> ml; gaseosas -> unidades
  const use = {
    chicken:0, chicha:0, maracuya:0, limonada:0,
    soda_500:0, soda_1000:0, soda_1500:0, soda_3000:0
  };

  for(const it of (items||[])){
    const p = PMAP[it.id];
    if(!p) continue;
    const r = p.recipe || {};
    const qty = Number(it.qty||0);
    if(!qty || !r.ingredient || r.ingredient==='none') continue;

    if (p.deriveFromRecipe) {
      // Receta simple
      const ingr = r.ingredient;
      if(ingr==='chicken'){
        const per = Number(r.amount||0);
        if(per>0) use.chicken += qty * per;
      } else if (['chicha','maracuya','limonada'].includes(ingr)){
        const perMl = Number(r.amount_ml||0);
        if(perMl>0) use[ingr] += qty * perMl;
      } else if (ingr && ingr.startsWith('soda_')){
        const perU = Math.round(Number(r.amount_units||1));
        if(perU>0) use[ingr] += qty * perU;
      }
    } else if (Array.isArray(p.recipeList) && p.recipeList.length){
      // Receta múltiple
      for(const c of p.recipeList){
        const ingr = c.ingredient;
        if(!ingr) continue;
        if(ingr==='chicken'){
          const per = Number(c.amount||0);
          if(per>0) use.chicken += qty * per;
        } else if (['chicha','maracuya','limonada'].includes(ingr)){
          const perMl = Number(c.amount_ml||0);
          if(perMl>0) use[ingr] += qty * perMl;
        } else if (ingr.startsWith('soda_')){
          const perU = Math.round(Number(c.amount_units||1));
          if(perU>0) use[ingr] += qty * perU;
        }
      }
    } else {
      // Sin receta -> el descuento es sobre el propio producto (lo haces aparte si quieres)
      // Aquí NO restamos receta base
    }
  }

  // 3) Leer stock actual de TODAS las recetas que pueden cambiar
  const recIds = ['chicken','chicha','maracuya','limonada','soda_500','soda_1000','soda_1500','soda_3000'];
  const recSnaps = await Promise.all(recIds.map(id => getDoc(doc(db,'recipes',id))));
  const REC = {};
  recIds.forEach((id,i) => {
    const d = recSnaps[i].data?.() || recSnaps[i].data?.call?.(recSnaps[i]) || recSnaps[i].data() || {};
    REC[id] = { stock: Number(d.stock||0) };
  });

  // 4) Aplicar consumos
  const round3 = n => Math.round(n*1000)/1000;
  const batch  = writeBatch(db);

  // Pollo (unidades decimales)
  if(use.chicken>0){
    const next = Math.max(0, round3(REC.chicken.stock - use.chicken));
    batch.set(doc(db,'recipes','chicken'), { stock: next, kind:'chicken', updatedAt: serverTimestamp() }, { merge:true });
  }

  // Bebidas (ml)
  for(const id of ['chicha','maracuya','limonada']){
    const u = use[id]; if(u>0){
      const next = Math.max(0, Math.round(REC[id].stock - u));
      batch.set(doc(db,'recipes',id), { stock: next, kind:'volume_ml', updatedAt: serverTimestamp() }, { merge:true });
    }
  }

  // Gaseosas (unidades por bucket)
  for(const id of ['soda_500','soda_1000','soda_1500','soda_3000']){
    const u = use[id]; if(u>0){
      const next = Math.max(0, Math.round(REC[id].stock - u));
      batch.set(doc(db,'recipes',id), { stock: next, kind:'unit_bucket', updatedAt: serverTimestamp() }, { merge:true });
    }
  }

  await batch.commit();

  // Refresca la cache/base del inventario para que se vea al toque
  __REC_CACHE = null;
}

/* ========= FX (SVG/Toasts/Confetti) ========= */
function svgCheck(){
  return `
  <svg width="84" height="84" viewBox="0 0 84 84" fill="none">
    <circle cx="42" cy="42" r="40" stroke="rgba(34,197,94,.5)" stroke-width="4"></circle>
    <path d="M23 44 L36 57 L61 31" stroke="#22c55e" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" class="draw"></path>
  </svg>`;
}
function svgTrash(){
  return `
  <svg width="84" height="84" viewBox="0 0 84 84" fill="none">
    <circle cx="42" cy="42" r="40" stroke="rgba(239,68,68,.45)" stroke-width="4"></circle>
    <path d="M30 30 L54 54 M54 30 L30 54" stroke="#ef4444" stroke-width="6" stroke-linecap="round" class="draw"/>
  </svg>`;
}
function svgInfo(){
  return `
  <svg width="84" height="84" viewBox="0 0 84 84" fill="none">
    <circle cx="42" cy="42" r="40" stroke="rgba(59,130,246,.45)" stroke-width="4"></circle>
    <path d="M42 22 a1 1 0 1 0 0.01 0" stroke="#3b82f6" stroke-width="8"/>
    <path d="M42 34 v28" stroke="#3b82f6" stroke-width="6" stroke-linecap="round" class="draw"/>
  </svg>`;
}
function toast(msg, type='ok'){
  const box = $('#toaster');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<i class="fa-solid ${type==='ok'?'fa-circle-check':type==='danger'?'fa-circle-xmark':'fa-circle-exclamation'}"></i> <div>${msg}</div>`;
  box.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(-6px)'; setTimeout(()=>el.remove(),200); }, 2200);
}
function confettiBurst(){
  const root = $('#confetti');
  root.innerHTML='';
  const colors = ['#22c55e','#3b82f6','#ff7a00','#ef4444','#f59e0b','#a78bfa'];
  for(let i=0;i<40;i++){
    const piece = document.createElement('i');
    piece.style.left = Math.random()*100 + '%';
    piece.style.background = colors[Math.floor(Math.random()*colors.length)];
    piece.style.animationDelay = (Math.random()*0.25)+'s';
    piece.style.transform = `translateY(-20vh) rotate(${Math.random()*180}deg)`;
    root.appendChild(piece);
  }
  setTimeout(()=>root.innerHTML='',1500);
}
function showFX({kind='ok', title='¡Listo!', sub='Acción realizada.', buttons=[{label:'Cerrar', role:'close'}], confetti=false}={}){
  const fx = $('#fx'), ic = $('#fxIcon'), t=$('#fxTitle'), s=$('#fxSub'), btns=$('#fxBtns');
  ic.className = `fx-icon ${kind}`;
  ic.innerHTML = (kind==='ok'?svgCheck():kind==='danger'?svgTrash():svgInfo());
  t.textContent = title; s.textContent = sub || '';
  btns.innerHTML = '';
  buttons.forEach(b=>{
    const el = document.createElement('button');
    el.className = `btn ${b.role==='danger'?'danger':(b.role==='ok'?'ok':'')}`;
    el.textContent = b.label;
    el.onclick = ()=>{ fx.classList.remove('show'); b.onClick && b.onClick(); };
    btns.appendChild(el);
  });
  fx.classList.add('show');
  if(confetti) confettiBurst();
}
function confirmFX({title='¿Confirmar?', sub='Esta acción no se puede deshacer.', kind='warn', okText='Sí', cancelText='No'}={}){
  return new Promise(resolve=>{
    showFX({
      kind: kind==='danger'?'danger':'warn',
      title, sub,
      buttons:[
        {label:cancelText, role:'close', onClick:()=>resolve(false)},
        {label:okText, role:'ok', onClick:()=>resolve(true)}
      ]
    });
  });
}
function successFX(msg){ showFX({kind:'ok', title:'¡Hecho!', sub:msg, buttons:[{label:'OK', role:'ok'}], confetti:true}); }
function errorFX(msg){ showFX({kind:'danger', title:'Ups…', sub:msg, buttons:[{label:'Entendido', role:'close'}]}); }

/* ========= Día ========= */
function dayRange(dateObj){
  const s=new Date(dateObj.getFullYear(),dateObj.getMonth(),dateObj.getDate(),0,0,0,0);
  const e=new Date(dateObj.getFullYear(),dateObj.getMonth(),dateObj.getDate(),23,59,59,999);
  return {start:Timestamp.fromDate(s),end:Timestamp.fromDate(e)};
}

/* ========= Hoy vendido ========= */
{
  const { start, end } = dayRange(new Date());
  const qy = query(
    collection(db, 'sales'),
    where('createdAt', '>=', start),
    where('createdAt', '<=', end)
  );

  onSnapshot(qy, snap => {
    let total = 0;
    snap.forEach(d => total += (d.data().totals?.total || 0));

    const sold = $('#soldToday');
    const parent = sold?.parentElement;

    // Botón Receta (primero)
    if (parent && !$('#btnReceta')) {
      const r = document.createElement('a');
      r.id = 'btnReceta';
      r.href = '/receta';
      r.className = 'pill btn icon info';
      r.title = 'Receta general';
      r.setAttribute('aria-label', 'Receta general');
      r.innerHTML = '<i class="fa-solid fa-book"></i>';
      parent.insertBefore(r, sold);
    }

    // Botón Caja (después de Receta)
    if (parent && !$('#btnCaja')) {
      const b = document.createElement('button');
      b.id = 'btnCaja';
      b.className = 'pill btn icon safe';
      b.title = 'Abrir caja';
      b.setAttribute('aria-label','Abrir caja');
      b.innerHTML = '<i class="fa-solid fa-vault"></i>';
      b.onclick = openCaja;
      parent.insertBefore(b, sold);
    }

    // Botón Info (último, antes de "Hoy vendido")
    if (parent && !$('#btnHoy')) {
      const a = document.createElement('a');
      a.id = 'btnHoy';
      a.href = '/hoy';
      a.className = 'pill btn icon info';
      a.title = 'Ver detalle de hoy';
      a.setAttribute('aria-label','Ver detalle de hoy');
      a.innerHTML = '<i class="fa-solid fa-circle-info"></i>';
      parent.insertBefore(a, sold);
    }

    sold.innerHTML = `<i class="fa-solid fa-chart-line"></i> Hoy vendido: ${fmt(total)}`;
  });
}


 /* ========= Cats/Products ========= */
 const DEFAULT_CATS=[
   {id:'bebidas',name:'Bebidas'},
   {id:'gaseosas',name:'Gaseosas'},
   {id:'pollos_brasa',name:'Pollos a la Brasa'},
   {id:'pollos_broster',name:'Pollos Broster'},
   {id:'parrillas_familiares',name:'Parrillas Familiares'},
   {id:'guarniciones',name:'Guarniciones'},
   {id:'ofertas_promos',name:'Ofertas y Promos'},
   {id:'parrillas_personales', name:'Parrillas Personales'},
   {id:'chifa', name:'Chifa'},
   
 ];

async function loadCats(){
  CATS=[...DEFAULT_CATS];
  $('#cats').innerHTML='<button class="chip active" data-cat="all">Todos</button>'+CATS.map(c=>`<button class="chip" data-cat="${c.id}">${c.name}</button>`).join('');
}
async function loadProducts(){
  const snap=await getDocs(query(collection(db,'products'),orderBy('name')));
  PRODUCTS=snap.docs.map(d=>({id:d.id,...d.data()}));
}
await loadCats(); await loadProducts();

/* ========= Mesas ========= */
async function seedTablesIfEmpty(){
  const s=await getDocs(collection(db,'floors',FLOOR,'tables')); if(s.size) return;
  const tasks=[]; for(let n=1;n<=15;n++){
    tasks.push(setDoc(doc(db,'floors',FLOOR,'tables','m'+n),{
      number:n,status:'libre',total:0,currentOrderId:null,orderNo:null,updatedAt:serverTimestamp()
    }));
  }
  await Promise.all(tasks);
}
await seedTablesIfEmpty(); listenTables();

function listenTables(){
  if(unsubTables) unsubTables();
  unsubTables = onSnapshot(collection(db,'floors',FLOOR,'tables'), snap=>{
    const mesas=snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>a.number-b.number);
    $('#board').innerHTML=mesas.map(m=>{
      const has=m.currentOrderId; const cls=has?'has-order':''; const status=m.status||'libre';
      const tag=status==='precuenta'?'Precuenta':(status==='preparacion'?'Preparación':'Libre');
      const preview = has ? `
        <div class="preview">
          <div class="pv-row"><span class="pv-chip">${tag}</span><b>${fmt(m.total||0)}</b></div>
          <div class="pv-sub"><small><i class="fa-solid fa-hashtag"></i> ${m.orderNo||'—'}</small><small><i class="fa-solid fa-user"></i> CAJA</small></div>
        </div>` : `<span class="tag">Libre</span>`;
      return `<div class="tile ${cls}" data-table="${m.id}" data-num="${m.number}">
        <div class="num">Mesa ${m.number}</div>
        <button class="edit" title="Editar pedido" data-edit="${m.id}"><i class="fa-solid fa-pen"></i></button>
        ${preview}
      </div>`;
    }).join('');
  });
}

/* ===== Clicks tablero ===== */
$('#board').addEventListener('click', async (e)=>{
  const editBtn=e.target.closest('[data-edit]');
  if(editBtn){
    const id=editBtn.dataset.edit;
    const tRef=doc(db,'floors',FLOOR,'tables',id); const tSnap=await getDoc(tRef); const data=tSnap.data();
    CURRENT_TABLE={id, number:data.number}; $('#mesaLabel').textContent='Mesa '+data.number;
    if(data.currentOrderId){
      const o=await getDoc(doc(db,'orders',data.currentOrderId));
      openBuilder({mode:'mesa', table:CURRENT_TABLE, existing:o.exists()?{id:o.id,...o.data()}:null});
    } else {
      openBuilder({mode:'mesa', table:CURRENT_TABLE});
    }
    return;
  }

  const tile=e.target.closest('.tile'); if(!tile) return;
  const id=tile.dataset.table, num=Number(tile.dataset.num);
  CURRENT_TABLE={id, number:num}; $('#mesaLabel').textContent='Mesa '+num;

  CART={};
  const tRef=doc(db,'floors',FLOOR,'tables',id); const tSnap=await getDoc(tRef);
  const orderId=tSnap.data()?.currentOrderId;
  if(orderId){
    const o=await getDoc(doc(db,'orders',orderId));
    if(o.exists()){
      o.data().items.forEach(it=>CART[it.id]={...it});
    }
  }
  renderSideCart();
});

/* ===== Acciones laterales Mesa ===== */
$('#guardar').onclick=()=>saveOrderForCurrentTable().then(()=>{successFX('Pedido guardado.');}).catch(err=>errorFX(err.message));
$('#precuenta').onclick=()=>setMesaStatus('precuenta').then(()=>toast('Precuenta marcada','warn')).catch(err=>errorFX(err.message));
$('#cobrar').onclick=()=>openPay(calcTotals().tot);
$('#imprimir').onclick=()=>{
  const t=calcTotals(); if(!t.items.length){ return errorFX('No hay ítems para imprimir.'); }
  renderTicket(t.items, CURRENT_TABLE?('Mesa '+CURRENT_TABLE.number):'Mostrador', t.tot, '—'); printAfterPaint();
};
$('#liberar').onclick=async ()=>{
  if(!CURRENT_TABLE) return errorFX('Selecciona una mesa.');
  const ok = await confirmFX({title:'¿Liberar mesa?', sub:'Se cancelará el pedido en curso.', kind:'danger', okText:'Sí, liberar', cancelText:'No'});
  if(!ok) return;
  liberarMesa().then(()=>toast('Mesa liberada','ok')).catch(err=>errorFX(err.message));
};

async function setMesaStatus(st){
  if(!CURRENT_TABLE) throw new Error('Selecciona una mesa');
  const tRef=doc(db,'floors',FLOOR,'tables',CURRENT_TABLE.id);
  const tSnap=await getDoc(tRef); const orderId=tSnap.data()?.currentOrderId;
  if(!orderId) throw new Error('No hay pedido en esta mesa');
  await updateDoc(doc(db,'orders',orderId),{status:st,updatedAt:serverTimestamp()});
  await updateDoc(tRef,{status:st,updatedAt:serverTimestamp()});
}

/* ===== Carrito Mesa ===== */
function calcTotals(listObj){
  const items=Object.values(listObj||CART);
  const sub=items.reduce((a,b)=>a+b.price*b.qty,0);
  const igv=sub*IGV_RATE; return {items, sub, igv, tot:sub+igv};
}
function renderSideCart(){
  const {items,sub,tot}=calcTotals();
  $('#cart').innerHTML = items.length ? items.map(it=>`
    <div class="item"><div><b>${it.name}</b><br><span class="muted">${fmt(it.price)}</span></div>
    <div class="qty"><button data-op="-" data-id="${it.id}">-</button><span>${it.qty}</span><button data-op="+" data-id="${it.id}">+</button></div>
    <button class="btn danger rm" data-op="x" data-id="${it.id}" title="Quitar"><i class="fa-solid fa-xmark"></i></button></div>`).join('') : '<p class="muted">Carrito vacío.</p>';
  $('#sub').textContent=fmt(sub); $('#tot').textContent=fmt(tot);
}
$('#cart').addEventListener('click',e=>{
  const b=e.target.closest('button'); if(!b) return; const it=CART[b.dataset.id]; if(!it) return;
  if(b.dataset.op==='+') it.qty++;
  if(b.dataset.op==='-'&&it.qty>1) it.qty--;
  else if(b.dataset.op==='-'&&it.qty===1) delete CART[b.dataset.id];
  if(b.dataset.op==='x') delete CART[b.dataset.id];
  renderSideCart();
});

async function saveOrderForCurrentTable(){
  if(!CURRENT_TABLE) throw new Error('Selecciona una mesa');
  const {items,sub,tot}=calcTotals();
  if(!items.length) throw new Error('Agrega productos al carrito');
  const tRef=doc(db,'floors',FLOOR,'tables',CURRENT_TABLE.id);
  const tSnap=await getDoc(tRef); let orderId=tSnap.data()?.currentOrderId;
  if(!orderId){
    const num = await nextOrderNo();
    const oRef=await addDoc(collection(db,'orders'),{mode:'mesa',floorId:FLOOR,tableId:CURRENT_TABLE.id,items,subtotal:sub,igv:0,total:tot,status:'preparacion',orderNo:num,createdAt:serverTimestamp(),updatedAt:serverTimestamp()});
    orderId=oRef.id;
    await updateDoc(tRef,{currentOrderId:orderId,total:tot,status:'preparacion',orderNo:num,updatedAt:serverTimestamp()});
  } else {
    await updateDoc(doc(db,'orders',orderId),{items,subtotal:sub,igv:0,total:tot,updatedAt:serverTimestamp()});
    await updateDoc(tRef,{total:tot,updatedAt:serverTimestamp()});
  }
}

async function liberarMesa(){
  if(!CURRENT_TABLE) throw new Error('Selecciona una mesa');
  const tRef=doc(db,'floors',FLOOR,'tables',CURRENT_TABLE.id);
  const tSnap=await getDoc(tRef); const orderId=tSnap.data()?.currentOrderId;
  if(orderId){ await updateDoc(doc(db,'orders',orderId),{status:'cancelado',updatedAt:serverTimestamp()}); }
  await updateDoc(tRef,{status:'libre',total:0,currentOrderId:null,orderNo:null,updatedAt:serverTimestamp()});
  CURRENT_TABLE=null; CART={}; renderSideCart(); $('#mesaLabel').textContent='Sin mesa seleccionada';
}

/* ========= Builder ========= */
const modalBuild=$('#modalBuild'); let BMODE='mesa'; let BTABLE=null; let B_CART={}, B_PRODUCTS=[]; let B_EXISTING=null;
function openBuilder({mode, table, existing=null}){
  BMODE=mode; BTABLE = table||null; B_EXISTING=existing; B_CART={}; B_PRODUCTS=[...PRODUCTS];
  $('#buildTitle').innerHTML = `<i class="fa-solid fa-list-ul"></i> ${existing?'Editar':'Nueva'} orden — ${mode==='mesa'?'Mesa '+(table?.number||'-'): (mode==='llevar'?'Para llevar':'Delivery')}`;
  $('#buildContext').textContent = mode==='mesa' ? `Mesa ${table?.number||'-'}` : (mode==='llevar'?'Para llevar':'Delivery');
  $('#deliveryFields').style.display = mode==='delivery' ? 'flex' : 'none';
  if(existing?.items){ existing.items.forEach(it=>B_CART[it.id]={...it}); }
  $('#q').value=''; renderBuilder();
  modalBuild.classList.add('show');
}
$('#bCancel').onclick=()=>modalBuild.classList.remove('show');
$('#clearQ').onclick=()=>{ $('#q').value=''; renderBuilder(); };
$('#cats').addEventListener('click',e=>{ const b=e.target.closest('.chip'); if(!b) return; $$('#cats .chip').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderBuilder(); });
$('#q').addEventListener('input',renderBuilder);
$('#grid').addEventListener('click',e=>{
  const id=e.target.closest('[data-add]')?.dataset.add; if(!id) return;
  const p=B_PRODUCTS.find(x=>x.id===id); if(!p) return;
  if(!B_CART[p.id]) B_CART[p.id]={id:p.id,productId:p.id,name:p.name,price:Number(p.price||0),qty:0};
  B_CART[p.id].qty++; renderBuilderCart();
});
$('#mini').addEventListener('click',e=>{
  const b=e.target.closest('button'); if(!b) return; const it=B_CART[b.dataset.id]; if(!it) return;
  if(b.dataset.op==='+') it.qty++; if(b.dataset.op==='-'&&it.qty>1) it.qty--; else if(b.dataset.op==='-'&&it.qty===1) delete B_CART[b.dataset.id];
  if(b.dataset.op==='x') delete B_CART[b.dataset.id]; renderBuilderCart();
});
function renderBuilder(){
  const term=$('#q').value.toLowerCase(); const cat=$('#cats .chip.active')?.dataset.cat||'all';
  const list=B_PRODUCTS.filter(p=>(cat==='all'||p.catId===cat)&&(term===''||p.name.toLowerCase().includes(term)));
  $('#grid').innerHTML = list.map(p=>`
    <div class="card">
      <div style="display:flex;gap:10px;align-items:center">
        <div class="thumb">${p.img?`<img src="${p.img}">`:`<i class="fa-solid fa-drumstick-bite"></i>`}</div>
        <div><div style="font-weight:700">${p.name}</div><div class="muted">${fmt(p.price)}</div></div>
      </div>
      <button class="btn primary" data-add="${p.id}"><i class="fa-solid fa-plus"></i> Agregar</button>
    </div>`).join('');
  renderBuilderCart();
}
function renderBuilderCart(){
  const {items,sub,tot}=calcTotals(B_CART);
  $('#mini').innerHTML = items.length ? items.map(it=>`
    <div class="miniItem"><div><b>${it.name}</b><br><span class="muted">${fmt(it.price)}</span></div>
      <div class="qty"><button data-op="-" data-id="${it.id}">-</button><span>${it.qty}</span><button data-op="+" data-id="${it.id}">+</button></div>
      <button class="btn danger rm" data-op="x" data-id="${it.id}" title="Quitar"><i class="fa-solid fa-xmark"></i></button></div>`).join('') : '<p class="muted">Agrega productos →</p>';
  $('#bsub').textContent=fmt(sub); $('#btot').textContent=fmt(tot);
}
$('#bSave').onclick   = ()=>builderSaveLike('save').then(()=>{modalBuild.classList.remove('show'); successFX('Pedido guardado.');}).catch(err=>errorFX(err.message));
$('#bPre').onclick    = ()=>builderSaveLike('pre').then(()=>toast('Precuenta lista','warn')).catch(err=>errorFX(err.message));
$('#bPay').onclick    = ()=>builderSaveLike('pay').catch(err=>errorFX(err.message));
$('#bPrint').onclick  = ()=>{
  const t=calcTotals(B_CART); if(!t.items.length){ return errorFX('Nada para imprimir.'); }
  const label=(BMODE==='mesa'&&BTABLE)?('Mesa '+BTABLE.number):(BMODE==='llevar'?'Para llevar':'Delivery');
  renderTicket(t.items,label,t.tot,'—'); printAfterPaint();
};

async function nextOrderNo(){
  return await runTransaction(db, async (tx)=>{
    const id=ymd(new Date());
    const ref=doc(db,'counters','orders');
    const snap=await tx.get(ref);
    let current=0;
    if(!snap.exists()){ tx.set(ref,{day:id,current:1}); current=1; }
    else { const d=snap.data(); if(d.day!==id){ current=1; tx.update(ref,{day:id,current:1}); } else { current=(d.current||0)+1; tx.update(ref,{current}); } }
    return String(current).padStart(4,'0');
  });
}
async function builderSaveLike(action){
  const {items,sub,tot}=calcTotals(B_CART);
  if(!items.length) throw new Error('Agrega productos.');

  let orderId=null;
  const label = (BMODE==='mesa' ? ('Mesa '+BTABLE?.number) : (BMODE==='llevar'?'Para llevar':'Delivery'));

  if (BMODE === 'mesa') {
    const tRef = doc(db,'floors',FLOOR,'tables',BTABLE.id);
    const tSnap = await getDoc(tRef);
    orderId = tSnap.data()?.currentOrderId;

    if (!orderId) {
      const num = await nextOrderNo();
      const oRef = await addDoc(collection(db,'orders'), {
        mode:'mesa', floorId:FLOOR, tableId:BTABLE.id,
        items, subtotal:sub, igv:0, total:tot,
        status:'preparacion', orderNo:num,
        createdAt:serverTimestamp(), updatedAt:serverTimestamp()
      });
      orderId = oRef.id;
      await updateDoc(tRef, {
        currentOrderId:orderId, total:tot, status:'preparacion', orderNo:num, updatedAt:serverTimestamp()
      });
    } else {
      await updateDoc(doc(db,'orders',orderId), {
        items, subtotal:sub, igv:0, total:tot, updatedAt:serverTimestamp()
      });
      await updateDoc(tRef,{ total:tot, updatedAt:serverTimestamp() });
    }

    if (action==='pre')  { await updateDoc(doc(db,'orders',orderId),{status:'precuenta'}); await updateDoc(tRef,{status:'precuenta'}); }
    if (action==='save') { CART={}; items.forEach(it=>CART[it.id]={...it}); renderSideCart(); toast('Pedido guardado','ok'); }
    if (action==='pay')  { openPay(tot, {orderId, label, items, mode:'mesa', table:BTABLE}); return; }

  } else {
    const base = {
      mode: BMODE, items, subtotal: sub, igv: 0, total: tot,
      status: 'preparacion', createdAt: serverTimestamp(), updatedAt: serverTimestamp()
    };
    if (BMODE === 'delivery') {
      base.customer = {
        name: $('#cliName').value || '',
        phone: $('#cliPhone').value || '',
        address: $('#cliAddr').value || ''
      };
    }

    if (B_EXISTING && B_EXISTING.id) {
      await updateDoc(doc(db, 'orders', B_EXISTING.id), base);
      orderId = B_EXISTING.id;
    } else {
      const num = await nextOrderNo();
      base.orderNo = num;
      const oRef = await addDoc(collection(db, 'orders'), base);
      orderId = oRef.id;
    }

    if (action === 'pre')  { await updateDoc(doc(db,'orders',orderId),{status:'precuenta'}); toast('Precuenta lista','warn'); }
    if (action === 'save') { toast('Pedido guardado','ok'); }
    if (action === 'pay')  { openPay(tot, {orderId, label, items, mode:BMODE}); return; }
  }
}

/* ========= Pedidos HOY (llevar/delivery) ========= */
function watchOrdersToday(){
  if (unsubOrdersToday) unsubOrdersToday();
  const {start,end}=dayRange(new Date());
  const qAll = query(
    collection(db,'orders'),
    where('createdAt','>=',start),
    where('createdAt','<=',end),
    orderBy('createdAt','desc')
  );
  unsubOrdersToday = onSnapshot(qAll, snap=>{
    const all = snap.docs.map(d=>({id:d.id, ...d.data()}));
    const visible = o => (o.mode==='llevar'||o.mode==='delivery') && o.status!=='pagado' && o.status!=='cancelado';
    renderOrders('#listLlevar',  all.filter(o=>visible(o)&&o.mode==='llevar'),  'llevar');
    renderOrders('#listDelivery',all.filter(o=>visible(o)&&o.mode==='delivery'),'delivery');
  });
}

function renderOrders(selector, list, kind){
  const box=$(selector);
  if(!list.length){ box.innerHTML='<p class="muted">No hay pedidos de hoy.</p>'; return; }
  box.innerHTML = list.map((o,i)=>`
    <div class="card-tile" data-open="${o.id}" data-kind="${kind}">
      <div class="card-head">
        <div style="font-weight:900">${kind==='llevar'?'PEDIDO':'DELIVERY'} ${String(i+1).padStart(2,'0')}</div>
        <span class="card-badge">${o.status==='precuenta'?'Precuenta':'Preparación'}</span>
      </div>
      <div class="card-foot">
        <div class="muted">#${o.orderNo||'—'} • ${o.items.length} ítem(s)</div>
        <b>${fmt(o.total)}</b>
      </div>
      ${kind==='delivery' && (o.customer?.name||o.customer?.phone||o.customer?.address) ? 
        `<div class="muted" style="margin-top:6px"><i class="fa-solid fa-user"></i> ${(o.customer?.name||'')}
          ${o.customer?.phone?(' • '+o.customer.phone):''}
          ${o.customer?.address?(' • '+o.customer.address):''}</div>`:''}
      <div class="card-actions">
        <button class="btn icon" title="Editar"   data-ed="${o.id}"  data-kind="${kind}"><i class="fa-solid fa-pen"></i></button>
        <button class="btn icon" title="Imprimir" data-pr="${o.id}"  data-kind="${kind}"><i class="fa-solid fa-print"></i></button>
        <button class="btn icon" title="Cobrar"   data-co="${o.id}"  data-kind="${kind}"><i class="fa-solid fa-money-bill"></i></button>
        <button class="btn icon danger" title="Eliminar" data-del="${o.id}" data-kind="${kind}"><i class="fa-solid fa-trash"></i></button>
      </div>
    </div>`).join('');

  box.querySelectorAll('[data-open],[data-ed],[data-pr],[data-co],[data-del]').forEach(el=>{
    el.addEventListener('click', async (e)=>{
      e.stopPropagation();
      const id = el.dataset.open||el.dataset.ed||el.dataset.pr||el.dataset.co||el.dataset.del;
      const o=await getDoc(doc(db,'orders',id)); if(!o.exists()) return;
      const data=o.data();

      if(kind==='llevar'){ CURRENT_LLEVAR={id:o.id, ...data}; showLlevarDetails(CURRENT_LLEVAR); }
      if(kind==='delivery'){ CURRENT_DELIVERY={id:o.id, ...data}; showDeliveryDetails(CURRENT_DELIVERY); }

      if(el.dataset.ed)  editOrder(id, kind);
      if(el.dataset.pr)  printOrderId(id, kind);
      if(el.dataset.co)  chargeOrderId(id, kind);
      if(el.dataset.del){
        const ok = await confirmFX({title:'¿Cancelar pedido?', sub:'Se marcará como cancelado.', kind:'danger', okText:'Sí, cancelar', cancelText:'No'});
        if(ok){ await updateDoc(doc(db,'orders',id),{status:'cancelado',updatedAt:serverTimestamp()}); showFX({kind:'danger', title:'Pedido cancelado', sub:'Se quitó de la lista.', buttons:[{label:'OK', role:'ok'}]}); }
      }
    }, {once:false});
  });
}

function editOrder(id){
  (async ()=>{ const o=await getDoc(doc(db,'orders',id)); if(!o.exists()) return;
    const data=o.data();
    BMODE = data.mode; BTABLE=null; B_EXISTING={id:o.id,...data}; B_CART={}; data.items.forEach(it=>B_CART[it.id]={...it});
    $('#buildTitle').innerHTML = `<i class="fa-solid fa-list-ul"></i> Editar orden — ${data.mode==='llevar'?'Para llevar':'Delivery'}`;
    $('#buildContext').textContent = data.mode==='llevar'?'Para llevar':'Delivery';
    $('#deliveryFields').style.display = data.mode==='delivery' ? 'flex' : 'none';
    modalBuild.classList.add('show'); renderBuilder(); renderBuilderCart();
  })();
}
function printOrderId(id){
  (async ()=>{ const o=await getDoc(doc(db,'orders',id)); if(!o.exists()) return;
    const data=o.data(); renderTicket(data.items, data.mode==='llevar'?'Para Llevar':'Delivery', data.total, data.orderNo||'—'); printAfterPaint();
  })();
}
function chargeOrderId(id){
  (async ()=>{ const o=await getDoc(doc(db,'orders',id)); if(!o.exists()) return;
    const data=o.data(); openPay(data.total, {orderId:id,label:data.mode==='llevar'?'Para llevar':'Delivery',items:data.items,mode:data.mode});
  })();
}

/* ========= Panel lateral Llevar/Delivery ========= */
let CURRENT_LLEVAR=null, CURRENT_DELIVERY=null;
function showLlevarDetails(o){
  $('#llevarLabel').textContent = o ? (`Pedido #${o.orderNo||'—'} • Para llevar`) : 'Sin orden seleccionada';
  if(!o){ $('#llevarCart').innerHTML='<p class="muted">Sin orden.</p>'; $('#llevarSub').textContent='S/ 0.00'; $('#llevarTot').textContent='S/ 0.00'; return; }
  const items = o.items||[];
  const sub = items.reduce((a,b)=>a+b.price*b.qty,0);
  $('#llevarCart').innerHTML = items.length ? items.map(it=>`
    <div class="item"><div><b>${it.name}</b><br><span class="muted">${fmt(it.price)}</span></div>
      <div class="qty"><span>${it.qty}</span></div>
      <span></span></div>`).join('') : '<p class="muted">Sin ítems.</p>';
  $('#llevarSub').textContent=fmt(sub); $('#llevarTot').textContent=fmt(sub);
}
$('#llevarEdit').onclick = ()=>{ if(!CURRENT_LLEVAR) return errorFX('Selecciona un pedido'); editOrder(CURRENT_LLEVAR.id,'llevar'); };
$('#llevarImprimir').onclick = ()=>{ if(!CURRENT_LLEVAR) return errorFX('Selecciona un pedido'); printOrderId(CURRENT_LLEVAR.id,'llevar'); };
$('#llevarCobrar').onclick = ()=>{ if(!CURRENT_LLEVAR) return errorFX('Selecciona un pedido'); chargeOrderId(CURRENT_LLEVAR.id,'llevar'); };
$('#llevarCancelar').onclick = async ()=>{ if(!CURRENT_LLEVAR) return errorFX('Selecciona un pedido'); const ok=await confirmFX({title:'¿Cancelar pedido?', kind:'danger', okText:'Sí'}); if(ok){ await updateDoc(doc(db,'orders',CURRENT_LLEVAR.id),{status:'cancelado',updatedAt:serverTimestamp()}); showFX({kind:'danger', title:'Pedido cancelado', sub:'Se quitó de la lista.', buttons:[{label:'OK', role:'ok'}]}); } };

function showDeliveryDetails(o){
  $('#deliveryLabel').textContent = o ? (`Delivery #${o.orderNo || '—'}`) : 'Sin delivery seleccionado';
  if(!o){ $('#deliveryCart').innerHTML='<p class="muted">Sin orden.</p>'; $('#deliverySub').textContent='S/ 0.00'; $('#deliveryTot').textContent='S/ 0.00'; return; }
  const items = o.items || [];
  const sub = items.reduce((a,b)=>a + b.price * b.qty, 0);
  $('#deliveryCart').innerHTML = items.length
    ? items.map(it => `<div class="item"><div><b>${it.name}</b><br><span class="muted">${fmt(it.price)}</span></div><div class="qty"><span>${it.qty}</span></div><span></span></div>`).join('')
    : '<p class="muted">Sin ítems.</p>';
  $('#deliverySub').textContent = fmt(sub);
  $('#deliveryTot').textContent = fmt(sub);
}
$('#deliveryEdit').onclick     = ()=>{ if(!CURRENT_DELIVERY) return errorFX('Selecciona un delivery'); editOrder(CURRENT_DELIVERY.id,'delivery'); };
$('#deliveryImprimir').onclick = ()=>{ if(!CURRENT_DELIVERY) return errorFX('Selecciona un delivery'); printOrderId(CURRENT_DELIVERY.id,'delivery'); };
$('#deliveryCobrar').onclick   = ()=>{ if(!CURRENT_DELIVERY) return errorFX('Selecciona un delivery'); chargeOrderId(CURRENT_DELIVERY.id,'delivery'); };
$('#deliveryCancelar').onclick = async ()=>{
  if(!CURRENT_DELIVERY) return errorFX('Selecciona un delivery');
  const ok = await confirmFX({title:'¿Cancelar delivery?', kind:'danger', okText:'Sí, cancelar'});
  if(ok){ await updateDoc(doc(db,'orders',CURRENT_DELIVERY.id),{status:'cancelado',updatedAt:serverTimestamp()}); showFX({kind:'danger', title:'Delivery cancelado', sub:'Se quitó de la lista.', buttons:[{label:'OK', role:'ok'}]}); }
};

/* ========= Pago ========= */
const modalPay = $('#modalPay');
const payMethod = $('#payMethod');
const payAmount = $('#payAmount');

// === UI método de pago (tabs) ===
const payTabs = $('#payTabs');
payTabs.addEventListener('click', (e)=>{
  const t = e.target.closest('.pay-tab'); if(!t) return;
  payTabs.querySelectorAll('.pay-tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  payMethod.value = t.dataset.method; // mantiene compat con tu lógica
  updatePaySummary();
});

// === Resumen (Total / Recibido / Cambio) ===
let _lastTotal = 0;

function setPayTotalView(total){
  _lastTotal = Number(total||0);
  $('#payTotal').textContent = fmt(_lastTotal);
  updatePaySummary();
}
function updatePaySummary(){
  const inAmt = Number($('#payAmount').value || 0);
  $('#payIn').textContent = fmt(inAmt);
  const diff = inAmt - _lastTotal;
  const method = $('#payMethod').value;
  const hint = $('#payHint');

  if(method === 'cash'){
    $('#payChange').textContent = fmt(Math.max(0, diff));
    hint.textContent = diff < 0 ? 'Falta recibir efectivo.' : (diff > 0 ? 'Entregar cambio.' : 'Monto exacto.');
  }else{
    $('#payChange').textContent = 'S/ 0.00';
    hint.textContent = 'Confirma el pago en el POS o app (no hay cambio).';
  }
}
$('#payAmount').addEventListener('input', updatePaySummary);

// === Abrir / cerrar modal de pago ===
function openPay(total, context=null){
  payAmount.value = Number(total||0).toFixed(2);
  setPayTotalView(total);
  modalPay.classList.add('show');
  modalPay.dataset.ctx = context ? JSON.stringify(context) : '';
  // foco al monto
  setTimeout(()=> payAmount.focus(), 50);
}
// Enter = confirmar
modalPay.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    e.preventDefault();
    $('#confirmPay').click();
  }
});

// === Confirmar pago ===
let _payBusy = false;
// === Confirmar pago ===
$('#confirmPay').onclick = async ()=>{
  if(_payBusy) return;                 // antirebote
  _payBusy = true; $('#confirmPay').disabled = true;

  try{
    const amount = Number(payAmount.value||0);
    const method = payMethod.value;     // cash | qr | visa | mastercard

    // Datos del cliente (opcionales)
    const customer = {
      dni:   ($('#payDni').value||'').trim(),
      name:  ($('#payName').value||'').trim(),
      phone: ($('#payPhone').value||'').trim(),
      email: ($('#payEmail').value||'').trim(),
    };

    const ctx = modalPay.dataset.ctx ? JSON.parse(modalPay.dataset.ctx) : null;

    let items, label, orderId, orderMode;

    // ====== RESOLVER ORDEN E ÍTEMS ======
    if(!ctx){
      const t = calcTotals();
      items = t.items;
      if(!items.length) return errorFX('No hay ítems.');  // evita cobrar vacío

      label = CURRENT_TABLE ? ('Mesa ' + CURRENT_TABLE.number) : 'Mostrador';
      orderMode = CURRENT_TABLE ? 'mesa' : 'llevar';

      if(CURRENT_TABLE){
        const tRef  = doc(db,'floors',FLOOR,'tables',CURRENT_TABLE.id);
        const tSnap = await getDoc(tRef);
        orderId = tSnap.data()?.currentOrderId;

        if(!orderId){
          const num = await nextOrderNo();
          const oRef = await addDoc(collection(db,'orders'),{
            mode:'mesa', floorId:FLOOR, tableId:CURRENT_TABLE.id,
            items, subtotal:t.sub, igv:0, total:t.tot,
            status:'preparacion', orderNo:num,
            createdAt:serverTimestamp(), updatedAt:serverTimestamp(),
            customer
          });
          orderId = oRef.id;
          await updateDoc(tRef,{
            currentOrderId:orderId, total:t.tot, status:'preparacion', orderNo:num, updatedAt:serverTimestamp()
          });
        } else {
          await updateDoc(doc(db,'orders',orderId),{
            items, subtotal:t.sub, igv:0, total:t.tot, updatedAt:serverTimestamp(), customer
          });
        }
      } else {
        const oRef = await addDoc(collection(db,'orders'),{
          mode:'llevar', items, subtotal:t.sub, igv:0, total:t.tot,
          status:'preparacion', createdAt:serverTimestamp(), updatedAt:serverTimestamp(),
          customer
        });
        orderId = oRef.id;
      }
    } else {
      items     = ctx.items;
      label     = ctx.label;
      orderId   = ctx.orderId;
      orderMode = ctx.mode;

      if(!items?.length) return errorFX('No hay ítems.');

      // persiste/actualiza datos del cliente si viene desde builder/lista
      try{ await updateDoc(doc(db,'orders',orderId),{customer,updatedAt:serverTimestamp()}); }catch(e){}
    }

    const total = items.reduce((a,b)=>a + b.price*b.qty, 0);

    // Validación: efectivo requiere monto >= total
    if(method === 'cash' && amount < total){
      return errorFX('Monto insuficiente en efectivo.');
    }

    // ====== EVITA COBRAR DOS VECES Y DUPLICAR DESCUENTO DE STOCK ======
    const ordRef  = doc(db,'orders',orderId);
    const ordSnap = await getDoc(ordRef);
    const ordData = ordSnap.data() || {};

    if(ordData.status === 'pagado'){
      return errorFX('Este pedido ya está pagado.');
    }
    const alreadyAdjusted = !!ordData.stockAdjusted;

    // ====== CORRELATIVO DE VENTA ======
    const num = await runTransaction(db, async (tx)=>{
      const id = ymd(new Date());
      const ref = doc(db,'counters','sales');
      const snap = await tx.get(ref);
      let current = 0;
      if(!snap.exists()){
        tx.set(ref,{day:id,current:1}); current = 1;
      }else{
        const d = snap.data();
        if(d.day !== id){ current = 1; tx.update(ref,{day:id,current:1}); }
        else { current = (d.current||0)+1; tx.update(ref,{current}); }
      }
      return String(current).padStart(4,'0');
    });

    // ====== REGISTRAR VENTA (con snapshot de ítems) ======
await addDoc(collection(db,'sales'),{
  type: 'normal',                  // clasifica la venta
  orderId,                         // vínculo con la orden
  receiptNo: num,                  // correlativo del día
  mode: orderMode,                 // mesa | llevar | delivery
  orderNo: (ordData?.orderNo ?? null),
  tableId: (ordData?.tableId ?? null),
  label,                           // “Mesa 5” / “Para llevar” / “Delivery”
  // ÍTEMS comprados (se guardan aquí mismo):
  items: (items||[]).map(it=>({
    id: it.id,
    name: it.name,
    price: Number(it.price||0),
    qty: Number(it.qty||0)
  })),
  totals: { subtotal: total, igv: 0, total },
  payments: [{ method, amount: method==='cash' ? amount : total }],
  customer,
  createdAt: serverTimestamp()
});

    // ====== AJUSTAR STOCK (una sola vez) + MARCAR PAGADO ======
    // ====== CONSUMIR RECETAS (pollo en 1/8, bebidas en ml) ======
if(!alreadyAdjusted){
  await consumeRecipesFromSale(items);
}
    await updateDoc(ordRef,{
  status:'pagado',
  stockAdjusted:true,
  paidAt: serverTimestamp(),           // cuándo se pagó
  payment:{
    method,
    amount: method==='cash' ? amount : total,
    receiptNo: num
  },
  updatedAt:serverTimestamp(),
  customer
});

    // Si fue mesa, liberar mesa
    if (CURRENT_TABLE){
      await updateDoc(doc(db,'floors',FLOOR,'tables',CURRENT_TABLE.id),{
        status:'libre', total:0, currentOrderId:null, orderNo:null, updatedAt:serverTimestamp()
      });
      CURRENT_TABLE = null; CART = {}; renderSideCart(); $('#mesaLabel').textContent='Sin mesa seleccionada';
    }

    // Cerrar modal y feedback
    modalPay.classList.remove('show');
    modalPay.dataset.ctx = '';
    successFX('Pago registrado. ¡Gracias!');
    renderTicket(items, label, total, num, method);
    printAfterPaint();

  }catch(err){
    console.error(err);
    errorFX(err?.message || 'Error procesando pago.');
  }finally{
    _payBusy = false; $('#confirmPay').disabled = false;
  }
};
// === /Confirmar pago ===


// ===== Cierre rápido de modales: X, fondo y tecla ESC =====

// 3.1 Cerrar al hacer clic en cualquier elemento con [data-close-modal]
document.addEventListener('click', (e)=>{
  const closeBtn = e.target.closest('[data-close-modal]');
  if(closeBtn){
    const modal = closeBtn.closest('.modal');
    if(modal){
      modal.classList.remove('show');
      // Si el modal usa dataset.ctx (como modalPay), lo limpiamos por si acaso
      modal.dataset.ctx = '';
    }
  }
});

// 3.2 Cerrar si hacen clic en el fondo (fuera de .box)
document.querySelectorAll('.modal').forEach(m=>{
  m.addEventListener('click', (e)=>{
    if(e.target === m){
      m.classList.remove('show');
      m.dataset.ctx = '';
    }
  });
});

// 3.3 Cerrar con tecla ESC
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    document.querySelectorAll('.modal.show').forEach(m=>{
      m.classList.remove('show');
      m.dataset.ctx = '';
    });
  }
});

/* ===== Descuenta stock según RECETA ===== */
async function adjustStock(items){
  const use = {
  chicken:0, chicha:0, maracuya:0, limonada:0,
  soda_500:0, soda_1000:0, soda_1500:0, soda_3000:0
};

  // 1) Cargar productos y acumular consumo
  for(const it of (items||[])){
    const pRef = doc(db,'products', it.productId || it.id);
    const snap = await getDoc(pRef);
    if(!snap.exists()) continue;
    const p = {id:snap.id, ...snap.data()};
    const qty = Number(it.qty||0);
    const r = p.recipe;

    if(!qty || !r || !r.ingredient || r.ingredient==='none') continue;

    if(r.ingredient==='chicken'){
      const per = Number(r.amount||0);     // ej. 0.125
      if(per>0) use.chicken += qty * per;
    } else if (['chicha','maracuya','limonada'].includes(r.ingredient)){
      const perMl = Number(r.amount_ml||0); // ej. 500
      if(perMl>0) use[r.ingredient] += qty * perMl;
    } else {
      // Productos sin receta: se descuenta su propio stock entero
      const cur = Number(p.stock||0);
      const next = Math.max(0, cur - qty);
      await updateDoc(pRef, { stock: next, updatedAt: serverTimestamp() });
    }
  }

  // 2) Actualizar recetas
  const batch = writeBatch(db);
  const recRefs = {
    chicken: doc(db,'recipes','chicken'),
    chicha: doc(db,'recipes','chicha'),
    maracuya: doc(db,'recipes','maracuya'),
    limonada: doc(db,'recipes','limonada')
  };

  const round3 = n => Math.round(n*1000)/1000;

  if(use.chicken>0){
    const snap = await getDoc(recRefs.chicken);
    const cur = Number(snap.data()?.stock||0);
    batch.set(recRefs.chicken,{ stock: Math.max(0, round3(cur - use.chicken)), updatedAt:serverTimestamp() },{merge:true});
  }
  for(const id of ['chicha','maracuya','limonada']){
    if(use[id]>0){
      const snap = await getDoc(recRefs[id]);
      const cur = Number(snap.data()?.stock||0);
      batch.set(recRefs[id],{ stock: Math.max(0, cur - use[id]), updatedAt:serverTimestamp() },{merge:true});
    }
  }

  await batch.commit();
}

/* ===== Print helpers ===== */
function printAfterPaint(){
  return new Promise(resolve=>{
    requestAnimationFrame(()=>{
      requestAnimationFrame(()=>{
        window.print();
        resolve();
      });
    });
  });
}
window.addEventListener('afterprint', ()=>{ document.getElementById('ticket').classList.remove('show'); });

// renderTicket(items, label, total, num, pay?)
function renderTicket(items, label, total, num, pay){
  document.getElementById('t-logo-img').src = TICKET_LOGO_URL;
  document.getElementById('t-brand').textContent = BUSINESS_NAME;
  document.getElementById('t-tagline').textContent = `"${BUSINESS_TAGLINE}"`;
  document.getElementById('t-kind').textContent = label || '—';
  document.getElementById('t-num').textContent  = num || ('B' + Date.now());
  document.getElementById('t-date').textContent = new Date().toLocaleString();

  const rows = (items||[]).map(it => `
    <tr>
      <td>${it.qty}</td>
      <td>${it.name}</td>
      <td class="right">S/ ${Number((it.qty||0)*(it.price||0)).toFixed(2)}</td>
    </tr>`).join('');
  document.getElementById('t-body').innerHTML = rows || '<tr><td colspan="3">—</td></tr>';

  document.getElementById('t-total').textContent = 'S/ ' + Number(total||0).toFixed(2);

  // === NUEVO: método(s) debajo del Total ===
  let payHtml = '';
  if (Array.isArray(pay) && pay.length){
    payHtml = pay.map(p => `<div class="row"><span>${methodLabel(p.method)}:</span><span>S/ ${Number(p.amount ?? total).toFixed(2)}</span></div>`).join('');
  } else if (pay && typeof pay === 'object' && pay.method){
    payHtml = `<div class="row"><span>${methodLabel(pay.method)}:</span><span>S/ ${Number(total||0).toFixed(2)}</span></div>`;
  } else if (typeof pay === 'string'){
    payHtml = `<div class="row"><span>${methodLabel(pay)}:</span><span>S/ ${Number(total||0).toFixed(2)}</span></div>`;
  } else {
    payHtml = ''; // precuenta/impresión sin pago
  }
  document.getElementById('t-payRows').innerHTML = payHtml;

  document.getElementById('ticket').classList.add('show');
}

/* ========= Modos ========= */
$('#modes').addEventListener('click',(e)=>{
  const b=e.target.closest('.tab'); if(!b) return;
  $$('#modes .tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');
  MODE=b.dataset.mode;
  $('#view-mesa').style.display    = MODE==='mesa'?'grid':'none';
  $('#view-llevar').style.display  = MODE==='llevar'?'grid':'none';
  $('#view-delivery').style.display= MODE==='delivery'?'grid':'none';
  if(MODE!=='mesa') watchOrdersToday();

  // >>> NUEVO: mostrar/ocultar el botón "Mover mesas"
  toggleMoveBtn();
});
$('#btnNuevaLlevar').onclick  = ()=>openBuilder({mode:'llevar'});
$('#btnNuevaDelivery').onclick= ()=>openBuilder({mode:'delivery'});

/* ========= Mover Mesas (modal + DnD) ========= */
const btnMove = $('#btnMoveTables');
const modalMove = $('#modalMove');

function toggleMoveBtn(){
  // Solo visible cuando la vista activa es MESAS
  btnMove.style.display = (MODE === 'mesa') ? 'inline-flex' : 'none';
}
// mostrar/ocultar al cargar
toggleMoveBtn();

btnMove.onclick = async ()=>{
  await renderTablesGrid();
  modalMove.classList.add('show');
};

// Renderiza la grilla de mesas del piso actual (FLOOR)
async function renderTablesGrid(){
  const grid = $('#tablesGrid');
  grid.innerHTML = '<div class="muted">Cargando…</div>';

  const snap = await getDocs(collection(db,'floors',FLOOR,'tables'));
  const mesas = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>a.number-b.number);

  grid.innerHTML = '';
  const cells = [];

  mesas.forEach(m=>{
    const el = document.createElement('div');
    el.className = `tcell ${m.currentOrderId ? 'busy' : ''}`;
    el.setAttribute('draggable','true');
    el.dataset.id = m.id;
    el.dataset.num = m.number;

    el.innerHTML = `
      <div class="tnum">Mesa ${m.number}</div>
      <div class="tmeta">
        ${m.currentOrderId ? `<i class="fa-solid fa-circle" style="color:#22c55e"></i> Con pedido • ${fmt(m.total||0)}`
                           : `<i class="fa-regular fa-circle"></i> Vacía`}
      </div>
    `;
    grid.appendChild(el);
    cells.push(el);
  });

  // Drag & Drop
  cells.forEach(el=>{
    el.addEventListener('dragstart', (e)=>{
      el.classList.add('dragging');
      e.dataTransfer.setData('text/plain', el.dataset.id);
    });
    el.addEventListener('dragend', ()=> el.classList.remove('dragging'));
    el.addEventListener('dragover', (e)=>{ e.preventDefault(); el.classList.add('drop-ok'); });
    el.addEventListener('dragleave', ()=> el.classList.remove('drop-ok'));
    el.addEventListener('drop', async (e)=>{
      e.preventDefault();
      el.classList.remove('drop-ok');
      const fromId = e.dataTransfer.getData('text/plain');
      const toId   = el.dataset.id;
      if(!fromId || !toId || fromId === toId) return;

      const fromNum = cells.find(x=>x.dataset.id===fromId)?.dataset.num;
      const toNum   = el.dataset.num;

      const ok = await confirmFX({
        title:`¿Intercambiar Mesa ${fromNum} ↔ Mesa ${toNum}?`,
        sub:'Se moverán los pedidos de HOY entre esas mesas.',
        kind:'warn', okText:'Sí, intercambiar', cancelText:'Cancelar'
      });
      if(!ok) return;

      try{
        await swapTablesFirestore(fromId, toId);
        toast('Mesas intercambiadas', 'ok');
        await renderTablesGrid(); // refresca el grid del modal
      }catch(err){
        console.error(err);
        errorFX(err?.message || 'No se pudo mover la mesa.');
      }
    });
  });
}

// Intercambia los pedidos entre dos mesas (A↔B) del PISO actual
async function swapTablesFirestore(aId, bId){
  const aRef = doc(db,'floors',FLOOR,'tables',aId);
  const bRef = doc(db,'floors',FLOOR,'tables',bId);

  const [aSnap, bSnap] = await Promise.all([getDoc(aRef), getDoc(bRef)]);
  if(!aSnap.exists() || !bSnap.exists()) throw new Error('Mesa no encontrada');

  const A = aSnap.data();  // {currentOrderId, total, status, orderNo, ...}
  const B = bSnap.data();

  const batch = writeBatch(db);

  // Helper para dejar correcto el estado de mesa
  const fieldsFrom = (t)=>({
    currentOrderId: t?.currentOrderId || null,
    total: Number(t?.total || 0),
    status: t?.currentOrderId ? (t?.status || 'preparacion') : 'libre',
    orderNo: t?.orderNo || null,
    updatedAt: serverTimestamp()
  });

  // 1) Intercambia "lo que tiene cada mesa"
  batch.update(aRef, fieldsFrom(B));
  batch.update(bRef, fieldsFrom(A));

  // 2) Actualiza en cada pedido su tableId para apuntar a la nueva mesa
  if(A?.currentOrderId){
    batch.update(doc(db,'orders', A.currentOrderId), { tableId: bId, updatedAt: serverTimestamp() });
  }
  if(B?.currentOrderId){
    batch.update(doc(db,'orders', B.currentOrderId), { tableId: aId, updatedAt: serverTimestamp() });
  }

  await batch.commit();

  // El listener real-time de #board (listenTables) actualizará el tablero principal
}

/* ========= INVENTARIO ========= */
const inv = $('#inv');
$('#btnInventory').onclick = ()=>{
  __REC_CACHE = null;            // fuerza recarga de base de recetas
  inv.classList.add('show');
  renderInventory();
};
$('#closeInv').onclick     = ()=>inv.classList.remove('show');
$('#addProduct').onclick   = ()=>addInventoryRow();
$('#invSearch').addEventListener('input',()=>renderInventory($('#invSearch').value.trim().toLowerCase()));

// ===== Helpers para mostrar el stock BASE (como en Recetario)
let __REC_CACHE = null;

async function loadRecipeBaseCache(){
  if(__REC_CACHE) return __REC_CACHE;
  const ids = [
  'chicken','chicha','maracuya','limonada',
  'soda_500','soda_1000','soda_1500','soda_3000'
];
  const snaps = await Promise.all(ids.map(id => getDoc(doc(db,'recipes',id))));
  __REC_CACHE = {};
  ids.forEach((id,i)=>{
    const d = snaps[i].data?.() || snaps[i].data?.call?.(snaps[i]) || snaps[i].data() || {};
    __REC_CACHE[id] = Number(d.stock || 0); // pollo en unidades decimales; bebidas en ml
  });
  return __REC_CACHE;
}

function trimZeros(s){
  return String(s)
    .replace(/(\.\d*?[1-9])0+$/,'$1')
    .replace(/\.0+$/,'');
}

// Devuelve el número BASE mostrado en la tabla de inventario
// - Pollo: unidades decimales con 3 decimales (10.125, 9.875, ...)
// - Bebidas: en L (ml/1000) con 2 decimales
// - Gaseosas: unidades enteras por bucket
async function baseNumericFor(p){
  const r = p?.recipe || {};
  if(!p?.deriveFromRecipe || !r.ingredient || r.ingredient === 'none'){
    return trimZeros(Number(p?.stock || 0).toFixed(3));
  }
  const cache = await loadRecipeBaseCache();
  const base = Number(cache[r.ingredient] || 0);

  if (r.ingredient === 'chicken') {
    return trimZeros(base.toFixed(3));
  }
  if (['chicha','maracuya','limonada'].includes(r.ingredient)) {
    return trimZeros((base/1000).toFixed(2));
  }
  if (r.ingredient.startsWith('soda_')) {
    return String(Math.floor(base));
  }
  // fallback
  return trimZeros(base.toFixed(3));
}

function addInventoryRow(p=null){
  const id = p?.id || ('tmp_'+Math.random().toString(36).slice(2));
  const row = document.createElement('div');
  row.className='inv-row'; 
  row.dataset.id=id;

  row.innerHTML = `
  <div style="display:flex;align-items:center;gap:8px">
    <div class="avatar">${p?.img?`<img src="${p.img}">`:'<i class="fa-solid fa-image"></i>'}</div>
    <input placeholder="Nombre" value="${p?.name||''}" class="pname">
  </div>
  <input type="number" step="0.01" min="0" value="${p?.price??0}" class="pprice">
  <input type="number" inputmode="decimal" step="0.001" min="0" value="" class="pstock" title="El stock se gestiona en Recetario">

  <select class="pcat">
    ${CATS.map(c=>`<option value="${c.id}" ${p?.catId===c.id?'selected':''}>${c.name}</option>`).join('')}
  </select>
  <div>
    <input type="file" accept="image/*" class="pimg" style="display:none">
    <button class="pill btn up"><i class="fa-solid fa-upload"></i> Subir</button>
  </div>
  <button class="pill btn save"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
  <button class="pill btn danger del"><i class="fa-solid fa-trash"></i> Eliminar</button>
  <button class="pill btn info"><i class="fa-solid fa-circle-info"></i> Info</button>
`;

  $('#invBody').prepend(row);
  
  // === STOCK reflejado de Receta (legible) y BLOQUEADO en Inventario ===
const stockInp = row.querySelector('.pstock');
if (stockInp) {
  stockInp.disabled = true;
  stockInp.classList.add('derived');
  stockInp.title = 'Stock base de receta (pollo en decimales, bebidas en L, gaseosas en unidades)';

  baseNumericFor(p).then(val => {
    stockInp.value = val; // ej: "10.125" o "125.50"
  }).catch(()=> {
    // Fallback por si falla la lectura de recipes
    stockInp.value = trimZeros((Number(p?.stock || 0)).toFixed(3));
  });
}

  // Botón Info (muestra el stock legible y el tipo de unidad si existe)
row.querySelector('.info').onclick = ()=>{
  const current = {
    stock: Number(row.querySelector('.pstock').value || p?.stock || 0),
    uKind:  p?.uKind || 'unit'
  };
  const kindLabel = U_KINDS[current.uKind] || 'UNIDADES';
  showFX({
    kind:'info',
    title:'Info de stock',
    sub:`${kindLabel} • Restante: ${humanStock(current)}`,
    buttons:[{label:'OK', role:'ok'}]
  });
};

  // Subir imagen
  row.querySelector('.up').onclick = ()=> row.querySelector('.pimg').click();
  row.querySelector('.pimg').onchange = async (ev)=>{
    const file = ev.target.files[0]; 
    if(!file) return;
    const ref = sRef(st, `products/${id}.jpg`);
    await uploadBytes(ref, file);
    const url = await getDownloadURL(ref);
    row.dataset.img = url;
    row.querySelector('.avatar').innerHTML = `<img src="${url}">`;
    toast('Imagen subida','ok');
  };

  // Guardar
  row.querySelector('.save').onclick = async ()=>{
    const name = row.querySelector('.pname').value.trim();
    const price= Number(row.querySelector('.pprice').value||0);
    const stock= Number(row.querySelector('.pstock').value||0);
    const catId= row.querySelector('.pcat').value;
    const img  = row.dataset.img || p?.img || '';
    if(!name){ return errorFX('Nombre requerido.'); }

    if(String(id).startsWith('tmp_')){
      const ref = await addDoc(collection(db,'products'),{ name, price, stock, catId, img, createdAt:serverTimestamp(), updatedAt:serverTimestamp() });
      row.dataset.id = ref.id;
    } else {
      await updateDoc(doc(db,'products', id),{ name, price, stock, catId, img, updatedAt:serverTimestamp() });
    }

    await loadProducts(); renderBuilder(); await renderInventory($('#invSearch').value.trim().toLowerCase());
    successFX('Producto guardado.');
  };

  // Eliminar
  row.querySelector('.del').onclick = async ()=>{
    const currentId = row.dataset.id;

    if (String(currentId).startsWith('tmp_')){ 
      const ok = await confirmFX({title:'¿Quitar fila?', sub:'Aún no fue guardado.', kind:'warn', okText:'Quitar'});
      if(ok){ row.remove(); toast('Fila eliminada','danger'); }
      return; 
    }

    const ok = await confirmFX({title:'¿Eliminar producto?', sub:'Se removerá del inventario.', kind:'danger', okText:'Eliminar', cancelText:'Cancelar'});
    if(!ok) return;

    try{ await deleteDoc(doc(db,'products', currentId)); }catch(e){ console.error(e); }
    try{ await deleteObject(sRef(st, `products/${currentId}.jpg`)); }catch(e){}

    await loadProducts(); renderBuilder(); await renderInventory($('#invSearch').value.trim().toLowerCase());
    showFX({kind:'danger', title:'Producto eliminado', sub:'Se borró del inventario.', buttons:[{label:'OK', role:'ok'}]});
  };
}

async function renderInventory(filter=''){
  $('#invBody').innerHTML='';
  const snap=await getDocs(query(collection(db,'products'),orderBy('name')));
  if(!snap.size){ addInventoryRow(); return; }
  snap.forEach(d=>{
    const p={id:d.id,...d.data()};
    if(filter && !(p.name||'').toLowerCase().includes(filter)) return;
    addInventoryRow(p);
  });
}

/* ========= HISTORIAL ========= */
const hist = $('#history');
$('#btnHistory').onclick=()=>{ hist.classList.add('show'); initHistoryDate(); loadHistory(); };
$('#hClose').onclick=()=>hist.classList.remove('show');
$('#hReload').onclick=()=>loadHistory();
$('#hXlsx').onclick=()=>downloadHistoryXlsx().catch(err=>errorFX('No se pudo generar Excel: '+err.message));

function initHistoryDate(){
  const today = ymd(new Date());
  $('#hDay').value = today;
}
async function loadHistory(){
  const dayStr = $('#hDay').value || ymd(new Date());
  const fromDate = new Date(dayStr + 'T00:00:00');
  const toDate   = new Date(dayStr + 'T23:59:59');

  const qy = query(
    collection(db,'sales'),
    where('createdAt','>=', Timestamp.fromDate(fromDate)),
    where('createdAt','<=', Timestamp.fromDate(toDate)),
    orderBy('createdAt','desc')
  );

  const snap = await getDocs(qy);
  const map = new Map();

  snap.forEach(d => {
    const dt = d.data().createdAt?.toDate ? d.data().createdAt.toDate() : new Date(d.data().createdAt);
    const k  = ymd(dt);
    const tot = d.data().totals?.total || 0;
    const row = map.get(k) || { total:0, count:0 };
    row.total += tot; row.count++;
    map.set(k, row);
  });

  const rows = [...map.entries()].sort((a,b)=> a[0] < b[0] ? 1 : -1);
  const tbody = $('#histTable tbody');
  tbody.innerHTML = rows.length
    ? rows.map(([d,r])=>`<tr><td>${d}</td><td class="right"><b>${fmt(r.total)}</b></td><td class="right">${r.count}</td></tr>`).join('')
    : `<tr><td colspan="3" class="muted">Sin ventas en la fecha.</td></tr>`;
}

/* ======= Descargar Excel con TODAS las ventas del día ======= */
async function downloadHistoryXlsx(){
  const dayStr = $('#hDay').value || ymd(new Date());
  const fromDate = new Date(dayStr + 'T00:00:00');
  const toDate   = new Date(dayStr + 'T23:59:59');

  const qy = query(
    collection(db,'sales'),
    where('createdAt','>=', Timestamp.fromDate(fromDate)),
    where('createdAt','<=', Timestamp.fromDate(toDate)),
    orderBy('createdAt','desc')
  );
  const snap = await getDocs(qy);
  if(snap.empty){ return errorFX('No hay ventas en esa fecha.'); }

  const rows = [];
  for (const docSnap of snap.docs){
    const s = docSnap.data();
    const created = s.createdAt?.toDate ? s.createdAt.toDate() : new Date(s.createdAt);
    const orderRef = doc(db,'orders', s.orderId);
    const orderSnap = await getDoc(orderRef);
    const order = orderSnap.exists() ? orderSnap.data() : {};
    const items = order.items || [];
    const mode  = (order.mode||'').toUpperCase();
    const receipt = s.receiptNo || '';
    const payMethod = (s.payments?.[0]?.method || '').toUpperCase();

    items.forEach(it=>{
      rows.push({
        Fecha: created.toLocaleDateString(),
        Hora:  created.toLocaleTimeString().slice(0,8),
        Comprobante: receipt,
        Modo: mode,
        Producto: it.name,
        Cantidad: Number(it.qty||0),
        Precio: Number(it.price||0),
        Subtotal_Item: Number((it.qty||0)*(it.price||0)),
        Total_orden: Number(s.totals?.total||0),
        Metodo_Pago: payMethod,
        OrderID: s.orderId
      });
    });
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  const headers = Object.keys(rows[0]||{
    Fecha:'',Hora:'',Comprobante:'',Modo:'',Producto:'',Cantidad:'',Precio:'',Subtotal_Item:'',Total_orden:'',Metodo_Pago:'',OrderID:''
  });
  ws['!cols'] = headers.map(h=>({wch: Math.max(12, String(h).length + 2)}));
  XLSX.utils.book_append_sheet(wb, ws, 'Ventas_'+dayStr);
  XLSX.writeFile(wb, `Ventas_${dayStr}.xlsx`);
}

/* ===== Caja: PIN numérico (usa el MISMO /verify-pin del login) ===== */
const modalCaja = $('#modalCaja');
const pinDots   = $('#pinDots');
const pinMsg    = $('#pinMsg');
const PIN_LEN   = 4;   // debe coincidir con tu backend (PIN_LEN)
let pinBuf = '';
let pinBusy = false;

function openCaja(){
  pinBuf=''; pinMsg.textContent=''; updatePinDots();
  modalCaja.classList.add('show');
}

function updatePinDots(){
  pinDots.querySelectorAll('span').forEach((s,i)=> s.classList.toggle('on', i < pinBuf.length));
}

function shakeDots(){
  pinDots.classList.remove('shake'); void pinDots.offsetWidth; pinDots.classList.add('shake');
}

async function submitPin(){
  if(pinBusy) return;
  if(pinBuf.length !== PIN_LEN){
    pinMsg.textContent = `Completa los ${PIN_LEN} dígitos.`; 
    shakeDots(); 
    return;
  }
  pinBusy = true; pinMsg.textContent = '';

  try{
    const r = await fetch('/verify-pin', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ pin: pinBuf })
    });
    const data = await r.json().catch(()=>({}));

    if(r.ok && data.ok){
      modalCaja.classList.remove('show');
      location.href = '/movimientos';   // redirección OK
      return;
    }
    // Error de PIN
    pinBuf = ''; updatePinDots();
    pinMsg.textContent = (data && data.error) ? data.error : 'PIN incorrecto';
    shakeDots(); if(navigator.vibrate) navigator.vibrate(120);

  }catch(e){
    pinMsg.textContent = 'Error de conexión';
  }finally{
    pinBusy = false;
  }
}

// Si existe el botón en el DOM estático, lo conectamos
document.getElementById('btnCaja')?.addEventListener('click', openCaja);

/* Clicks del teclado numérico del modal */
document.addEventListener('click', (e)=>{
  const b = e.target.closest('#pinPad button'); if(!b) return;
  const k = b.dataset.k;
  if (k === 'x'){ pinBuf = pinBuf.slice(0,-1); updatePinDots(); return; }
  if (k === 'ok'){ submitPin(); return; }
  if (/^[0-9]$/.test(k)){
    if(pinBuf.length < PIN_LEN){ pinBuf += k; updatePinDots(); }
    if(pinBuf.length === PIN_LEN) submitPin();
  }
});

/* Teclado físico mientras el modal está abierto */
document.addEventListener('keydown', (e)=>{
  if(!modalCaja.classList.contains('show')) return;
  if (e.key === 'Backspace'){ pinBuf = pinBuf.slice(0,-1); updatePinDots(); }
  else if (e.key === 'Enter'){ submitPin(); }
  else if (/^[0-9]$/.test(e.key)){
    if(pinBuf.length < PIN_LEN){ pinBuf += e.key; updatePinDots(); }
    if(pinBuf.length === PIN_LEN) submitPin();
  }
});

/* ========= Init ========= */
watchOrdersToday();
</script>

 
